/*
Package bitutil
è¯¥æ–‡ä»¶å®šä¹‰äº†å¯¹å­—èŠ‚åˆ‡ç‰‡è¿›è¡Œè§£å‹ç¼©çš„æ–¹æ³•ï¼š
  - å‹ç¼©ï¼šCompressBytes
  - è§£å‹ï¼šDecompressBytes
*/
package bitutil

import "errors"

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// å®šä¹‰ä¸€å †é”™è¯¯

var (
	// errMissingData å‹ç¼©æ•°æ®ä¸å®Œæ•´æ—¶ä¼šæŠ¥è¯¥é”™è¯¯
	errMissingData = errors.New("missing bytes on input")
	// errUnreferencedData è§£å‹ç¼©æ—¶ï¼Œè¯»å–å‹ç¼©æ•°æ®çš„é•¿åº¦ä¸ç­‰äºå‹ç¼©æ•°æ®çš„é•¿åº¦æ—¶ä¼šæŠ¥è¯¥é”™è¯¯
	errUnreferencedData = errors.New("extra bytes on input")
	// errExceededTarget è§£å‹ç¼©æ—¶ï¼Œç»™çš„å‹ç¼©æ•°æ®é•¿åº¦å¤§äºåŸå§‹æ•°æ®çš„é•¿åº¦æ—¶ä¼šæŠ¥è¯¥é”™è¯¯
	errExceededTarget = errors.New("target data size exceeded")
	// errZeroContent å‹ç¼©æ•°æ®ä¸­å«æœ‰é›¶å€¼ä¼šæŠ¥è¯¥é”™è¯¯
	errZeroContent = errors.New("zero byte in input content")
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// ğŸŒ¹å‹ç¼©ğŸŒ¹

// CompressBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// CompressBytes è°ƒç”¨ bitsetEncodeBytes æ–¹æ³•å®ç°å¯¹ç»™å®šå­—èŠ‚åˆ‡ç‰‡è¿›è¡Œå‹ç¼©ï¼Œå‹ç¼©è¿‡ç¨‹åˆ†ä¸‰ç§æƒ…å†µï¼š
//  1. å¦‚æœç»™å®šçš„dataæ˜¯ä¸€ä¸ªç©ºåˆ‡ç‰‡ï¼Œå‹ç¼©ç»“æœå°±æ˜¯nil
//  2. å¦‚æœç»™å®šçš„dataé•¿åº¦ç­‰äº1ï¼Œå¹¶ä¸”é‡Œé¢å”¯ä¸€çš„å­—èŠ‚ç­‰äº0ï¼Œå‹ç¼©ç»“æœå°±æ˜¯nilï¼Œå¦åˆ™å°±æ˜¯dataæœ¬èº«
//  3. å¦‚æœç»™å®šçš„dataé•¿åº¦å¤§äº1ï¼Œé‚£ä¹ˆå‹ç¼©ç»“æœçš„ç»“æ„å¦‚ä¸‹
//     |...|æ ‡è®°nonZeroBitset_1ä¸­é0å­—èŠ‚ä½ç½®çš„æ¯”ç‰¹æ•°ç»„nonZeroBitset_2|æ ‡è®°dataä¸­é0å­—èŠ‚ä½ç½®çš„æ¯”ç‰¹æ•°ç»„nonZeroBitset_1|dataä¸­é0å­—èŠ‚æ‹¼æ¥åœ¨ä¸€èµ·|
//     ä¾‹å¦‚dataæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º32çš„å­—èŠ‚åˆ‡ç‰‡ï¼Œå®ƒçš„ç¬¬4ã€14ã€24ä¸‹æ ‡å¤„çš„å€¼åˆ†åˆ«ç­‰äº1ã€2ã€3ï¼Œå…¶ä½™ä½ç½®çš„å€¼éƒ½ç­‰äº0ï¼Œå³
//     data = [0 0 0 0 1 0 0 0 0 0 0 0 0 0 2 0 0 0 0 0 0 0 0 0 3 0 0 0 0 0 0 0 0]
//     å‹ç¼©ç»“æœï¼š[208 1 2 128 1 2 3]
func CompressBytes(data []byte) []byte {
	if out := bitsetEncodeBytes(data); len(out) < len(data) {
		return out
	}
	cpy := make([]byte, len(data))
	copy(cpy, data)
	return cpy
}

// bitsetEncodeBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// bitsetEncodeBytes æ˜¯ä¸€ä¸ªé€’å½’æ–¹æ³•ï¼Œå®ƒæ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡dataä½œä¸ºå…¥å‚ï¼Œå®ƒç¬¬ä¸€æ¬¡é€’å½’çš„ç›®çš„æ˜¯å°†dataé‡Œæ‰€æœ‰éé›¶å€¼å•ç‹¬å–å‡ºï¼Œè®°å½•åˆ°ä¸€ä¸ªæ–°çš„
// å­—èŠ‚åˆ‡ç‰‡é‡Œï¼šnonZeroBytes := make([]byte, 0, len(data))ï¼Œç„¶åç”¨æ¯”ç‰¹ä½æ•°ç»„æ ‡è®°å‡ºdataå“ªäº›ä¸‹æ ‡ä½ç½®çš„å­—èŠ‚å€¼ä¸ç­‰äº0ï¼Œè¿™é‡Œä¼šç”¨ä¸€ä¸ª
// é¢å¤–çš„å­—èŠ‚åˆ‡ç‰‡æ¥ä½œè®°å½•ï¼šnonZeroBitset := make([]byte, (len(data)+7)/8)ï¼›ç¬¬äºŒæ¬¡é€’å½’ä¼šå°†nonZeroBitsetä½œä¸º bitsetEncodeBytes
// æ–¹æ³•çš„è¾“å…¥ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬äºŒæ¬¡é€’å½’çš„ä»»åŠ¡æ˜¯å¯¹æ¯”ç‰¹ä½æ•°ç»„åšå‹ç¼©ï¼Œç„¶åå°†å‹ç¼©çš„ç»“æœå’ŒnonZeroBytesæ•°ç»„æ‹¼æ¥èµ·æ¥ï¼Œå¾—åˆ°æœ€ç»ˆçš„å‹ç¼©ç»“æœã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ª
// ä¾‹å­ä½œä¸ºè¯´æ˜ï¼Œæ¥å…·ä½“çœ‹çœ‹å‹ç¼©çš„è¿‡ç¨‹ï¼š
//
//	å‡è®¾dataæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º32çš„å­—èŠ‚åˆ‡ç‰‡ï¼Œå®ƒçš„ç¬¬4ã€14ã€24ä¸‹æ ‡å¤„çš„å€¼åˆ†åˆ«ç­‰äº1ã€2ã€3ï¼Œå…¶ä½™ä½ç½®çš„å€¼éƒ½ç­‰äº0ï¼Œå³
//		data = [0 0 0 0 1 0 0 0 0 0 0 0 0 0 2 0 0 0 0 0 0 0 0 0 3 0 0 0 0 0 0 0 0]
//	ç¬¬ä¸€æ¬¡è¿­ä»£ï¼Œå–å‡ºdataé‡Œä¸ä¸º0çš„å­—èŠ‚å¹¶æ”¾å…¥åˆ°nonZeroBytes_1é‡Œï¼Œç„¶ååœ¨nonZeroBitset_1çš„ç¬¬4ã€ç¬¬14å’Œç¬¬24æ¯”ç‰¹ä½æ ‡è®°1ï¼Œå…¶ä½™ä½ç½®æ ‡è®°0ï¼Œ
//	å¾—åˆ°ç»“æœï¼š
//		nonZeroBytes_1 = [1 2 3] nonZeroBitset_1 = [00001000 00000010 00000000 10000000] = [8 2 0 128]
//	ç¬¬äºŒæ¬¡è¿­ä»£ï¼Œå–å‡ºnonZeroBitset_1é‡Œä¸ä¸º0çš„å­—èŠ‚æ”¾å…¥åˆ°nonZeroBytes_2é‡Œï¼Œç„¶ååœ¨nonZeroBitset_2çš„ç¬¬0ã€ç¬¬1ã€ç¬¬3æ¯”ç‰¹ä½æ ‡è®°1ï¼Œå…¶ä½™
//	ä½ç½®æ ‡è®°0ï¼Œå¾—åˆ°ç»“æœï¼š
//		nonZeroBytes_2 = [8 2 128] nonZeroBitset_2 = [11010000] = [208]
//	ç¬¬ä¸‰æ¬¡è¿­ä»£ï¼Œç”±äºnonZeroBitset_2çš„é•¿åº¦ç­‰äº1ï¼Œå¹¶ä¸”é‡Œé¢å”¯ä¸€çš„å­—èŠ‚ä¸ç­‰äº0ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›[208]ï¼Œè¿­ä»£è¿‡ç¨‹ç»“æŸã€‚
//
// ç°åœ¨å°±æ˜¯å°†ä¸Šè¿°è¿­ä»£è¿‡ç¨‹äº§ç”Ÿçš„ä¸­é—´å€¼è¿›è¡Œç»„åˆå°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„å‹ç¼©ç»“æœï¼š[208 8 2 128 1 2 3]
// æ€»ç»“ä¸€ä¸‹ï¼šå…ˆæŠŠåŸå§‹å­—èŠ‚åˆ‡ç‰‡ä¸­ä¸ä¸º0çš„å­—èŠ‚å…¨éƒ¨å–å‡ºæ¥æŒ‰é¡ºåºæ’æˆä¸€æ’ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¤±å»äº†åŸå§‹å­—èŠ‚åˆ‡ç‰‡ä¸­å€¼ä¸º0çš„å­—èŠ‚å’Œä¸ä¸º0çš„
// å­—èŠ‚åœ¨åŸå§‹åˆ‡ç‰‡ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬ç”¨æ¯”ç‰¹ä½æ ‡æ³¨å‡ºåŸå§‹å­—èŠ‚åˆ‡ç‰‡ä¸­å“ªäº›ä¸‹æ ‡å¤„çš„å­—èŠ‚ä¸ä¸º0ï¼Œä¸ä¸º0çš„åœ°æ–¹æ ‡1ï¼Œä¸º0çš„åœ°æ–¹æ ‡0ï¼Œè¿™æ ·æˆ‘ä»¬å°±åˆå¾—
// åˆ°äº†ä¸€ä¸ªæ–°çš„å­—èŠ‚åˆ‡ç‰‡æ¥å­˜å‚¨åŸå§‹åˆ‡ç‰‡ä¸­å„ä¸ªå­—èŠ‚çš„ä½ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥ä¸ºäº†å°½é‡å‹ç¼©æ•°æ®çš„å­˜å‚¨ç©ºé—´ï¼Œæˆ‘ä»¬åˆ©ç”¨ç›¸åŒçš„æ–¹æ³•ç»§ç»­å¯¹è¯¥æ–°å­—èŠ‚åˆ‡ç‰‡è¿›è¡Œå‹ç¼©ï¼Œ
// ç›´åˆ°æˆ‘ä»¬é€€å‡ºå‹ç¼©è¿‡ç¨‹ã€‚
func bitsetEncodeBytes(data []byte) []byte {
	// ç©ºåˆ‡ç‰‡çš„å‹ç¼©ç»“æœå°±æ˜¯nil
	if len(data) == 0 {
		return nil
	}
	// å¦‚æœåˆ‡ç‰‡é•¿åº¦ç­‰äº1ï¼Œå¹¶ä¸”å­˜å‚¨çš„å­—èŠ‚ç­‰äº0ï¼Œé‚£ä¹ˆå‹ç¼©ç»“æœæ˜¯nilï¼Œå¦åˆ™å°±æ˜¯è¯¥å­—èŠ‚æœ¬èº«
	if len(data) == 1 {
		if data[0] == 0 {
			return nil
		}
		return data
	}
	// å‡å¦‚dataçš„é•¿åº¦ç­‰äº13ï¼Œé‚£ä¹ˆnonZeroBitsetçš„é•¿åº¦ç­‰äº(13+7)/8=2
	// nonZeroBytesçš„å®¹é‡ç­‰äº13
	nonZeroBitset := make([]byte, (len(data)+7)/8)
	nonZeroBytes := make([]byte, 0, len(data))
	for i, b := range data {
		if b != 0 {
			nonZeroBytes = append(nonZeroBytes, b)
			// å½“æˆ‘ä»¬å¤„ç†dataé‡Œé¢ä¸‹æ ‡ä¸º2çš„å­—èŠ‚æ—¶ï¼ŒnonZeroBitset[0] = nonZeroBitset[0] | (1 << byte(7-2))
			// --> x = x | (00100000)ï¼šè¿™æ ·å¯ä»¥åœ¨å­—èŠ‚çš„å¯¹åº”ä½ç½®çš„æ¯”ç‰¹ä½æ ‡è®°1æ¥è®°å½•è¯¥ä½ç½®çš„å­—èŠ‚ä¸ºéé›¶å€¼
			// å½“æˆ‘ä»¬å¤„ç†dataé‡Œé¢ä¸‹æ ‡ä¸º4çš„å­—èŠ‚æ—¶ï¼ŒnonZeroBitset[0] = nonZeroBitset[0] | (1 << byte(7-4))
			// --> x = x | (00001000)
			nonZeroBitset[i/8] = nonZeroBitset[i/8] | (1 << byte(7-i%8))
		}
	}
	if len(nonZeroBytes) == 0 {
		// dataåˆ‡ç‰‡é‡Œæ‰€æœ‰å­—èŠ‚éƒ½ä¸º0
		return nil
	}
	return append(bitsetEncodeBytes(nonZeroBitset), nonZeroBytes...)
}

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// ğŸŒ¹è§£å‹ğŸŒ¹

// DecompressBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// DecompressBytes æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç»è¿‡å‹ç¼©åçš„å­—èŠ‚åˆ‡ç‰‡ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºå‹ç¼©å‰åŸå§‹å­—èŠ‚åˆ‡ç‰‡çš„é•¿åº¦ï¼Œ
// è¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨ bitsetDecodePartialBytes æ–¹æ³•æ¥è§£å‹æ•°æ®ã€‚
func DecompressBytes(data []byte, target int) ([]byte, error) {
	if len(data) > target {
		return nil, errExceededTarget
	}
	if len(data) == target {
		cpy := make([]byte, target)
		copy(cpy, data)
		return cpy, nil
	}
	return bitsetDecodeBytes(data, target)
}

// bitsetDecodeBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// bitsetDecodeBytes æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç»è¿‡å‹ç¼©åçš„å­—èŠ‚åˆ‡ç‰‡ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºå‹ç¼©å‰åŸå§‹å­—èŠ‚åˆ‡ç‰‡çš„é•¿åº¦ï¼Œ
// è¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨ bitsetDecodePartialBytes æ–¹æ³•æ¥è§£å‹æ•°æ®ã€‚
func bitsetDecodeBytes(data []byte, target int) ([]byte, error) {
	out, size, err := bitsetDecodePartialBytes(data, target)
	if err != nil {
		return nil, err
	}
	if size != len(data) {
		return nil, errUnreferencedData
	}
	return out, nil
}

// bitsetDecodePartialBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// bitsetDecodePartialBytes æ˜¯ä¸€ä¸ªé€’å½’æ–¹æ³•ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ï¼Œå®ƒæ˜¯å¯¹æŸä¸ªåˆ‡ç‰‡è¿›è¡Œå‹ç¼©åçš„ç»“æœï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯
// ä¸€ä¸ªæ•´æ•°ï¼Œå®ƒè¡¨ç¤ºå‹ç¼©å‰åŸå§‹æ•°æ®çš„é•¿åº¦ã€‚è¯¥æ–¹æ³•æ˜¯ä»æœ€å†…å±‚é€æ¸åé¦ˆåˆ°æœ€å¤–å±‚é€’å½’ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜è¯¥æ–¹æ³•è§£å‹ç¼©çš„è¿‡ç¨‹ï¼š
//
//	å‡è®¾dataçš„å€¼ç­‰äº[208 1 2 128 1 2 3]ï¼Œå®ƒæ˜¯å¯¹ä¸€ä¸ªé•¿åº¦ä¸º32çš„å­—èŠ‚åˆ‡ç‰‡è¿›è¡Œå‹ç¼©åçš„ç»“æœï¼Œæ‰€ä»¥ bitsetDecodePartialBytes æ–¹æ³•çš„ç¬¬
//	äºŒä¸ªè¾“å…¥å‚æ•°å°±æ˜¯32ï¼Œé‚£ä¹ˆä¸‹é¢å°±å¼€å§‹ä»‹ç»é€’å½’è¿‡ç¨‹ï¼š
//		ğŸš©ç¬¬ä¸€æ¬¡é€’å½’ï¼ŒnonZeroBitset_1, ptr_1, err_1 := bitsetDecodePartialBytes(data, 32)ï¼Œæ­¤æ—¶dataç­‰äº
//		[208 8 2 128 1 2 3]ï¼Œtargetç­‰äº32ï¼Œç”±äºtargetä¸ç­‰äº1ï¼Œæ‰€ä»¥è¿›å…¥ç¬¬äºŒæ¬¡è¿­ä»£ï¼›
//		ğŸš©ç¬¬äºŒæ¬¡è¿­ä»£ï¼ŒnonZeroBitset_2, ptr_2, err_2 := bitsetDecodePartialBytes(data, (target+7)/8)ï¼Œæ­¤æ—¶ï¼Œdataç­‰äº
//		[208 8 2 128 1 2 3]ï¼Œtargetç­‰äº4ï¼Œç”±äºtargetä¸ç­‰äº1ï¼Œæ‰€ä»¥è¿›å…¥ç¬¬ä¸‰æ¬¡è¿­ä»£ï¼›
//		ğŸš©ç¬¬ä¸‰æ¬¡è¿­ä»£ï¼ŒnonZeroBitset_3, ptr_3, err_3 := bitsetDecodePartialBytes(data, (target+7)/8)ï¼Œæ­¤æ—¶ï¼Œdataä¾ç„¶æ˜¯
//		[208 8 2 128 1 2 3]ï¼Œtargetç­‰äº(4+7)/8=1ï¼Œç”±äºtargetç­‰äº1ï¼Œæ‰€ä»¥è¿”å›data[0], 1, nilã€‚æ¥ç€æˆ‘ä»¬å°±è¦è¿”å›åˆ°ç¬¬äºŒæ¬¡è¿­ä»£
//	 	è¿‡ç¨‹é‡Œäº†ï¼›
//		ğŸš©å›åˆ°ç¬¬äºŒæ¬¡è¿­ä»£è¿‡ç¨‹ï¼ŒnonZeroBitset_2=[208]=[11010000]ï¼Œptr_2=1ï¼Œerr_2=nilï¼Œæ‰§è¡Œforå¾ªç¯ï¼Œå¾—åˆ°result=[8 2 0 128]ï¼Œptr=4ï¼Œ
//		ç„¶åè¿”å›åˆ°ç¬¬ä¸€æ¬¡è¿­ä»£è¿‡ç¨‹é‡Œï¼›
//		ğŸš©å›åˆ°ç¬¬ä¸€æ¬¡è¿­ä»£è¿‡ç¨‹ï¼ŒnonZeroBitset_1=[8 2 0 128]=[00001000 00000010 00000000 10000000]ï¼Œptr_1=4, err_1=nilï¼Œæ‰§è¡Œ
//		forå¾ªç¯ï¼Œå¾—åˆ°result=[0 0 0 0 1 0 0 0 0 0 0 0 0 0 2 0 0 0 0 0 0 0 0 0 3 0 0 0 0 0 0 0]ï¼Œptr=7ã€‚
func bitsetDecodePartialBytes(data []byte, target int) ([]byte, int, error) {
	if target == 0 {
		return nil, 0, nil
	}
	result := make([]byte, target)
	if len(data) == 0 {
		return result, 0, nil
	}
	if target == 1 {
		result[0] = data[0]
		if data[0] != 0 {
			return result, 1, nil
		}
		return result, 0, nil
	}
	nonZeroBitset, ptr, err := bitsetDecodePartialBytes(data, (target+7)/8)
	if err != nil {
		return nil, ptr, err
	}
	for i := 0; i < 8*len(nonZeroBitset); i++ { // 8*len(nonZeroBitset)ä»£è¡¨nonZeroBitseté‡Œé¢æœ‰å¤šå°‘ä¸ªæ¯”ç‰¹ä½
		if nonZeroBitset[i/8]&(1<<byte(7-i%8)) != 0 {
			if ptr >= len(data) {
				return nil, 0, errMissingData
			}
			if i >= len(result) {
				return nil, 0, errExceededTarget
			}
			if data[ptr] == 0 {
				return nil, 0, errZeroContent
			}
			result[i] = data[ptr]
			ptr++
		}
	}
	return result, ptr, nil
}
