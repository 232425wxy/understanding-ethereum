/*
Package bitutil
è¯¥æ–‡ä»¶å®šä¹‰äº†è‹¥å¹²å¯¹01æ¯”ç‰¹çš„æ“ä½œæ–¹æ³•
*/
package bitutil

import (
	"runtime"
	"unsafe"
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// wordSize â™ |ä½œè€…ï¼šå´ç¿”å®‡| ðŸ |æ—¥æœŸï¼š2022/10/27|
//
// wordSizeè¡¨ç¤ºå­˜å‚¨ä¸€ä¸ªæŒ‡é’ˆæ•°æ®éœ€è¦å¤šå°‘ä¸ªå­—èŠ‚ï¼Œåœ¨64ä½çš„Ubuntu 20.04æ“ä½œç³»ç»Ÿä¸­ï¼ŒwordSize çš„å€¼ç­‰äºŽ8.
const wordSize = int(unsafe.Sizeof(uintptr(0)))

// supportUnaligned â™ |ä½œè€…ï¼šå´ç¿”å®‡| ðŸ |æ—¥æœŸï¼š2022/10/27|
//
// supportUnalignedç”¨æ¥è¡¨ç¤ºå½“å‰çš„è®¡ç®—æœºæž¶æž„æ˜¯å¦æ”¯æŒå†…å­˜ä¸å¯¹é½ï¼Œåœ¨64ä½çš„Ubuntu 20.04æœºå™¨ä¸Šï¼ŒsupportAlignedçš„å€¼æ’ä¸ºtrueã€‚
const supportUnaligned = runtime.GOARCH == "386" || runtime.GOARCH == "amd64" || runtime.GOARCH == "ppc64" || runtime.GOARCH == "ppc64le" || runtime.GOARCH == "s390x"

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// å¼‚æˆ–è¿ç®—

// safeXORBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ðŸ |æ—¥æœŸï¼š2022/10/27|
//
// safeXORBytes æ–¹æ³•æŽ¥å—3ä¸ªå…¥å‚ï¼Œåˆ†åˆ«æ˜¯dstã€aã€bï¼Œè¯¥æ–¹æ³•å°±æ˜¯å¯¹ç»™å®šçš„aã€bä¸¤ä¸ªå­—èŠ‚åˆ‡ç‰‡ï¼Œè¿›è¡Œé€å­—èŠ‚çš„å¼‚æˆ–è¿ç®—ã€‚ä¸è¦æ±‚
// aã€bä¸¤ä¸ªå­—èŠ‚åˆ‡ç‰‡çš„é•¿åº¦å¿…é¡»ä¸€æ ·ï¼Œä½†æ˜¯è¦æ±‚dstå‚æ•°çš„é•¿åº¦è‡³å°‘ç­‰äºŽaã€bä¸­é•¿åº¦æœ€çŸ­çš„é‚£ä¸€ä¸ªï¼Œè¯¥æ–¹æ³•çš„è¿”å›žå€¼è¡¨ç¤ºå¯¹aæˆ–bä¸­å¤šå°‘
// ä¸ªå­—èŠ‚è¿›è¡Œäº†å¼‚æˆ–è¿ç®—ã€‚
//
//	ä¾‹å¦‚ï¼šè¾“å…¥a=[12 34 28] b=[3 67 98 55]ï¼Œç»è¿‡è¿ç®—ï¼Œdst=[15 97 126]
//	12 xor 3 -> 1100 xor 0011 -> 1111 -> 15
//	34 xor 67 -> 0100010 xor 1000011 -> 1100001 -> 97
//	28 xor 98 -> 0011100 xor 1100010 -> 1111110 -> 126
func safeXORBytes(dst, a, b []byte) int {
	n := len(a)
	if len(b) < n {
		n = len(b)
	}
	for i := 0; i < n; i++ {
		dst[i] = a[i] ^ b[i]
	}
	return n
}

// fastXORBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ðŸ |æ—¥æœŸï¼š2022/10/27|
//
// fastXORBytes æ–¹æ³•æŽ¥å—3ä¸ªå…¥å‚ï¼Œåˆ†åˆ«æ˜¯dstã€aã€bï¼Œè¯¥æ–¹æ³•å°±æ˜¯å¯¹ç»™å®šçš„aã€bä¸¤ä¸ªå­—èŠ‚åˆ‡ç‰‡è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œå¹¶å°†ç»“æžœå­˜åˆ°
// dstä¸­ï¼Œä½†æ˜¯è¯¥æ–¹æ³•æ¯” safeXORBytes æ–¹æ³•æ›´å¿«ï¼Œæ ¹æ®benchmarkçš„æ€§èƒ½è¡¨çŽ°ï¼Œå¯¹é•¿åº¦ä¸º100å­—èŠ‚çš„ä¸¤ä¸ªå­—èŠ‚åˆ‡ç‰‡è¿›è¡Œå¼‚æˆ–
// è¿ç®—ï¼Œè¯¥æ–¹æ³•æ¯” safeXORBytes æ–¹æ³•çš„39.45 ns/opï¼Œå¿«äº†å¤§çº¦1.5å€ã€‚
// è¯¥æ–¹æ³•çš„è¿ç®—é€Ÿåº¦æ¯”è¾ƒå¿«çš„åŽŸå› åœ¨äºŽä¸‹é¢çš„ä»£ç ï¼š
//
//	aw := *(*[]uintptr)(unsafe.Pointer(&a))
//	bw := *(*[]uintptr)(unsafe.Pointer(&b))
//
// ä¸Šé¢é‚£è¡Œä»£ç çš„ä½œç”¨æ˜¯ä»Žåˆ‡ç‰‡açš„å·¦ä¾§å¼€å§‹ï¼Œæ¯8ä¸ªå­—èŠ‚ä¼šè¢«ä»¥å°ç«¯å­˜å‚¨æ¨¡å¼è¿žæˆä¸€ä¸ª64ä½çš„åœ°å€å€¼ï¼Œç„¶åŽå­˜å…¥åˆ°æ–°çš„åˆ‡ç‰‡awé‡Œï¼Œ
// å°½ç®¡è¿™æ ·ï¼Œawçš„é•¿åº¦å¹¶ä¸æ˜¯ç­‰äºŽlen(a)/8ï¼Œè€Œæ˜¯ç­‰äºŽlen(a)ï¼Œä½†æ˜¯åªæœ‰aw[:len(a)/8]è¿™ä¸€æ®µæ‰æœ‰æ„ä¹‰ï¼Œbwä¸ŽawåŒç†ã€‚è¦
// é—®ä¸ºä»€ä¹ˆè¿™é‡Œæ˜¯æ¯8ä¸ªå­—èŠ‚ä¼šè¢«ä»¥å°ç«¯å­˜å‚¨æ¨¡å¼è¿žæˆä¸€ä¸ª64ä½çš„åœ°å€å€¼ï¼Œæ˜¯å› ä¸ºåœ¨64ä½çš„Ubuntu 20.04æ“ä½œç³»ç»Ÿä¸­ï¼Œåœ°å€å€¼çš„
// é•¿åº¦å°±æ˜¯64ä½ï¼Œå³æ­£å¥½8ä¸ªå­—èŠ‚ã€‚
// ä¾‹å¦‚ï¼Œå¦‚æžœåˆ‡ç‰‡a=[1 1 1 1 0 0 0 1]ï¼Œåˆ™awçš„å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š
//
//	aw = 0000000100000000000000000000000000000001000000010000000100000001ï¼Œç”¨æ•´æ•°è¡¨ç¤ºä¸ºï¼š72057594054770945
//
// æŽ¥ç€ï¼Œæˆ‘ä»¬å†åˆ©ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼š
//
//	for i := 0; i < n / wordSize; i++ {
//		dw[i] = aw[i] ^ bw[i]
//	}
//
// é€Ÿåº¦ä¼šæ˜Žæ˜¾åŠ å¿«ï¼Œå› ä¸ºä¸Šé¢ä»£ç é‡Œçš„ä¸€æ¬¡å¾ªçŽ¯æ˜¯å¯¹8å¯¹å­—èŠ‚åšå¼‚æˆ–è¿ç®—ã€‚ç”±äºŽç»™å®šçš„aã€bå­—èŠ‚åˆ‡ç‰‡çš„é•¿åº¦ä¸ä¸€å®šæ˜¯8çš„æ•´æ•°å€ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦
// åˆ©ç”¨å¦‚ä¸‹ä»£ç ï¼Œå¯¹å‰©ä¸‹çš„å­—èŠ‚åšå¼‚æˆ–è¿ç®—ï¼š
//
//	for i := n - n%wordSize; i < n; i++ {
//		dst[i] = a[i] ^ b[i]
//	}
func fastXORBytes(dst, a, b []byte) int {
	n := len(a)
	if len(b) < n {
		n = len(b)
	}
	w := n / wordSize
	if w > 0 {
		dw := *(*[]uintptr)(unsafe.Pointer(&dst))
		aw := *(*[]uintptr)(unsafe.Pointer(&a))
		bw := *(*[]uintptr)(unsafe.Pointer(&b))
		for i := 0; i < w; i++ {
			dw[i] = aw[i] ^ bw[i]
		}
	}
	for i := n - n%wordSize; i < n; i++ {
		dst[i] = a[i] ^ b[i]
	}
	return n
}
