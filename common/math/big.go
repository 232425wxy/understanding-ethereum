/*
Package math

è¯¥æ–‡ä»¶å†…å®šä¹‰äº†ä¸¤ä¸ªç»“æ„ä½“ï¼šHexOrDecimal256å’ŒDecimal256ï¼Œå®ƒä»¬çš„åº•å±‚å®ç°éƒ½æ˜¯big.Intï¼Œå®šä¹‰è¿™ä¸¤ä¸ªç»“æ„ä½“æ˜¯ä¸ºäº†å®ç°å¯¹big.Intè¿›è¡Œ
marshal/unmarshalï¼Œå®ƒä»¬ä¿©éƒ½å„è‡ªå®ç°äº†MarshalTextå’ŒUnmarshalTextæ–¹æ³•ï¼ŒHexOrDecimal256å’ŒDecimal256ä¸åŒçš„åœ°æ–¹åœ¨äºï¼š
  - HexOrDecimal256 çš„MarshalTextæ–¹æ³•ä¼šå°†å¤§æ•´æ•°ç¼–ç æˆ16è¿›åˆ¶æ•°ï¼Œå¹¶åœ¨å‰é¢åŠ ä¸Š"0x"å‰ç¼€ï¼Œè€Œ Decimal256 åªä¼šåœ¨åŸ10è¿›åˆ¶æ•°
    ä¸¤è¾¹åŠ ä¸ŠåŒå¼•å·å¾—åˆ°å­—ç¬¦ä¸²ï¼Œç„¶åå†å°†å­—ç¬¦ä¸²è½¬æ¢æˆå­—èŠ‚åˆ‡ç‰‡ï¼Œæ›´æœ¬ä¸ä¼šå°†åŸå¤§æ•´æ•°è½¬æ¢æˆ16è¿›åˆ¶ï¼Œæ›´ä¸ä¼šåœ¨å‰é¢åŠ ä¸Š"0x"å‰ç¼€ã€‚
  - HexOrDecimal256 çš„UnmarshalTextå’Œ Decimal256 åŠŸèƒ½ä¸€æ ·ï¼Œéƒ½èƒ½å°†å«æœ‰å‰ç¼€çš„16è¿›åˆ¶æˆ–è€…ä¸å«å‰ç¼€çš„10è¿›åˆ¶æ•°æ®è§£ææˆå¤§æ•´æ•°ã€‚

éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œæ— è®º HexOrDecimal256 è¿˜æ˜¯ Decimal256ï¼Œå®ƒä»¬æ‰€èƒ½æ”¯æŒçš„å¤§æ•´æ•°å¿…é¡»åœ¨256æ¯”ç‰¹ä»¥å†…ã€‚

éšåï¼Œè¯¥æ–‡ä»¶è¿˜å®šä¹‰äº†ä»¥ä¸‹æ–¹æ³•ï¼š

  - func BigPow(a, b int64) *big.Int

  - func BigMax(x, y *big.Int) *big.Int

  - func BigMin(x, y *big.Int) *big.Int

  - func FirstBitSet(i *big.Int) int

  - func ReadBits(bigInt *big.Int, buf []byte)

  - func PaddedBigBytes(bigInt *big.Int, n int) []byte

  - func Byte(bigInt *big.Int, padLen, n int) byte

    U256Bytes æ–¹æ³•å°†ä¸€ä¸ªç»™å®šçš„å¤§æ•´æ•°ï¼ˆæ¯”ç‰¹ä½å°äºç­‰äº256ï¼‰å¡«å……ä¸ºä¸€ä¸ªå«æœ‰32ä¸ªå­—èŠ‚çš„å¤§æ•´æ•°ï¼Œä»è€Œè½¬æ¢æˆä¹™å¤ªåŠè™šæ‹Ÿæœºé‡Œçš„æ”¯æŒçš„æ•°å­—

  - func U256Bytes(n *big.Int) []byte

    S256 æ–¹æ³•æ¥å—ä¸€ä¸ªå¤§æ•´æ•°xä½œä¸ºå…¥å‚ï¼Œå¦‚æœxå°äº2^255ï¼Œåˆ™ç›´æ¥è¿”å›xï¼Œå¦åˆ™è®¡ç®—x-2^256ï¼Œå¹¶è¿”å›è®¡ç®—ç»“æœ

  - func S256(x *big.Int) *big.Int

    Exp æ–¹æ³•æ¥å—ä¸¤ä¸ªå¤§æ•´æ•°baseå’Œexponentä½œä¸ºå…¥å‚ï¼Œç„¶åè®¡ç®—result=base^exponentï¼Œå¹¶å°†resultè¿”å›

  - func Exp(base, exponent *big.Int) *big.Int
*/
package math

import (
	"fmt"
	"math/big"
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

var (
	// tt255 = 2^255
	tt255 = BigPow(2, 255)
	// tt256 = 2^256
	tt256 = BigPow(2, 256)
	// tt256m1 = 2^256-1
	tt256m1 = new(big.Int).Sub(tt256, big.NewInt(1))
	// tt63 = 2^63
	tt63 = BigPow(2, 63)
	// MaxBig256 æ˜¯256æ¯”ç‰¹ä½æ‰€èƒ½è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°ï¼š115792089237316195423570985008687907853269984665640564039457584007913129639935
	MaxBig256 = new(big.Int).Set(tt256m1)
	// MaxBig63 = 2^63-1ï¼Œè¯¥å˜é‡åœ¨å®˜æ–¹çš„é¡¹ç›®æºç é‡Œå¹¶æ²¡æœ‰è¢«ä½¿ç”¨
	MaxBig63 = new(big.Int).Sub(tt63, big.NewInt(1))
)

const (
	// WordBits ç”¨æ¥è¡¨ç¤ºä¸€ä¸ª big.Word å¯ä»¥å­˜æ”¾å¤šå°‘ä¸ªæ¯”ç‰¹ä½ï¼Œåœ¨64ä½çš„Ubuntu 20.04æ“ä½œç³»ç»Ÿä¸­ï¼ŒwordBitsç­‰äº64ã€‚
	WordBits = 32 << (uint64(^(big.Word(0))) >> 63)
	// WordBytes ç”¨æ¥è¡¨ç¤ºä¸€ä¸ª big.Word æœ€å¤šå¯ä»¥å­˜æ”¾å¤šå°‘ä¸ªå­—èŠ‚ï¼Œåœ¨64ä½çš„Ubuntu 20.04æ“ä½œç³»ç»Ÿä¸­ï¼ŒwordBytesç­‰äº8ã€‚
	WordBytes = WordBits / 8
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// HexOrDecimal256 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// HexOrDecimal256 çš„åº•å±‚ç±»å‹æ˜¯ big.Intï¼Œå®šä¹‰è¯¥ç±»å‹å®ç°äº†å¯¹256ä½æ¯”ç‰¹ä»¥å†…çš„å¤§æ•´æ•°è¿›è¡Œmarshal/unmarshalã€‚
// å®ç°äº† MarshalText å’Œ UnmarshalText ä¸¤ä¸ªæ–¹æ³•ï¼ŒMarshalText æ–¹æ³•å°† HexOrDecimal256 ç¼–ç æˆ16è¿›åˆ¶çš„
// æ•°ï¼Œå¹¶å«æœ‰ "0x"å‰ç¼€ï¼›UnmarshalText æ–¹æ³•å¯¹ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡å†…å®¹è¿›è¡Œè§£ç ï¼Œå¦‚æœç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡å«æœ‰å‰ç¼€ï¼Œåˆ™æŠŠç»™å®š
// çš„å­—èŠ‚åˆ‡ç‰‡çœ‹æˆæ˜¯16è¿›åˆ¶çš„æ•°ï¼Œç„¶åè§£ææˆ10è¿›åˆ¶çš„å¤§æ•´æ•°ï¼Œå¦‚æœä¸å«å‰ç¼€ï¼Œåˆ™çœ‹æˆæ˜¯10è¿›åˆ¶çš„æ•°ã€‚
//
//	 ğŸš¨æ³¨æ„ï¼šHexOrDecimal256 ä½œä¸º10è¿›åˆ¶æ•°ï¼Œå…¶æœ€å¤§å–å€¼æ˜¯ï¼š
//		115792089237316195423570985008687907853269984665640564039457584007913129639935
type HexOrDecimal256 big.Int

// NewHexOrDecimal256 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// NewHexOrDecimal256 æ–¹æ³•æ¥å—ä¸€ä¸ªint64ç±»å‹çš„å‚æ•°xï¼Œç„¶åå°†xè½¬æ¢æˆä¸€ä¸ªå¤§æ•´æ•°ï¼Œæœ€åå†å°†è¿™ä¸ªå¤§æ•´æ•°é€šè¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸º HexOrDecimal256ã€‚
func NewHexOrDecimal256(x int64) *HexOrDecimal256 {
	bigInt := big.NewInt(x)
	h := HexOrDecimal256(*bigInt)
	return &h
}

// MarshalText â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•å®ç°äº† encoding.TextMarshaler æ¥å£ï¼Œå°†æ•°å­—è½¬æ¢ä¸º16è¿›åˆ¶ï¼Œç„¶ååœ¨å‰é¢åŠ ä¸Š"0x"å‰ç¼€ã€‚
//
//	ä¾‹å¦‚ï¼šHexOrDecimal256çš„å€¼ç­‰äº255ï¼Œç¼–ç åçš„ç»“æœä¸ºï¼š[48 120 102 102]ï¼Œå­—ç¬¦ä¸²å½¢å¼ï¼š"0xff"
//
// è¯¥æ–¹æ³•è¿”å›çš„ç¬¬äºŒä¸ªå‚æ•°æ°¸è¿œéƒ½æ˜¯nilã€‚
func (h *HexOrDecimal256) MarshalText() ([]byte, error) {
	if h == nil {
		return []byte("0x0"), nil
	}
	return []byte(fmt.Sprintf("%#x", (*big.Int)(h))), nil
}

// UnmarshalText â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•å®ç°äº† encoding.TextUnmarshaler æ¥å£ï¼Œè¯¥æ–¹æ³•å°†ç»™å®šçš„å­—ç¬¦ä¸²è§£ææˆä¸€ä¸ªå¤§æ•´æ•°ï¼Œç»™å®šçš„å­—ç¬¦ä¸²è¦ä¹ˆå«æœ‰"0x"æˆ–"0X"å‰
// ç¼€ï¼Œè¦ä¹ˆä¸å«æœ‰ï¼Œè¿™ä¼šå†³å®šä¸åŒçš„è§£ææ–¹å¼ï¼š
//  1. å¦‚æœç»™å®šçš„å­—ç¬¦ä¸²å«æœ‰å‰ç¼€ï¼Œåˆ™ç»™å®šçš„å­—ç¬¦ä¸²å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ‰èƒ½è§£ææˆåŠŸï¼š
//     - å­—ç¬¦ä¸²é‡Œé™¤äº†å‰ç¼€å¤–ï¼Œå…¶ä½™å­—ç¬¦çš„å–å€¼èŒƒå›´åªèƒ½åœ¨{0 1 2 3 4 5 6 7 8 9 a b c d e f A B C D E F}é‡Œ
//     - å®é™…ä¸Šï¼Œå°½ç®¡ç»™çš„å­—ç¬¦ä¸²æ˜¯16è¿›åˆ¶çš„ï¼Œä½†æ˜¯è§£æåå¾—åˆ°å¤§æ•´æ•°æ˜¯10è¿›åˆ¶å½¢å¼çš„ï¼Œå¦‚æœè§£æåçš„ç»“æœéœ€è¦è¶…è¿‡256ä½æ¯”ç‰¹å»å­˜å‚¨ï¼Œåˆ™è¯¥
//     æ–¹æ³•è®¤ä¸ºè§£æå¤±è´¥ï¼Œé»˜è®¤è§£æåæ‰€èƒ½è·å¾—çš„æœ€å¤§æ•´æ•°æ˜¯ï¼š
//     115792089237316195423570985008687907853269984665640564039457584007913129639935
//  2. å¦‚æœç»™å®šçš„å­—ç¬¦ä¸²ä¸å«æœ‰å‰ç¼€ï¼Œåˆ™ç»™å®šçš„å­—ç¬¦ä¸²å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ‰èƒ½è§£ææˆåŠŸï¼š
//     - å­—ç¬¦ä¸²é‡Œæ¯ä¸ªå­—ç¬¦çš„å–å€¼èŒƒå›´åªèƒ½åœ¨{0 1 2 3 4 5 6 7 8 9}é‡Œ
//     - è§£ç åå¾—åˆ°çš„å¤§æ•´æ•°å¿…é¡»å°äº115792089237316195423570985008687907853269984665640564039457584007913129639935
//     ç»™å‡ºä¸¤ä¸ªä¾‹å­ï¼š
//     - è¾“å…¥"0x12a"ï¼Œå¾—åˆ°ï¼š298
//     - è¾“å…¥"123"ï¼Œå¾—åˆ°ï¼š123
func (h *HexOrDecimal256) UnmarshalText(input []byte) error {
	bigInt, ok := ParseBig256(string(input))
	if !ok {
		return fmt.Errorf("invalid hex or decimal integer %q", input)
	}
	*h = HexOrDecimal256(*bigInt)
	return nil
}

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// ParseBig256 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// PareBig256 æ–¹æ³•å°†ç»™å®šçš„å­—ç¬¦ä¸²è§£ææˆä¸€ä¸ªå¤§æ•´æ•°ï¼Œç»™å®šçš„å­—ç¬¦ä¸²è¦ä¹ˆå«æœ‰"0x"æˆ–"0X"å‰ç¼€ï¼Œè¦ä¹ˆä¸å«æœ‰ï¼Œè¿™ä¼šå†³å®šä¸åŒçš„è§£ææ–¹å¼ï¼š
//  1. å¦‚æœç»™å®šçš„å­—ç¬¦ä¸²å«æœ‰å‰ç¼€ï¼Œåˆ™ç»™å®šçš„å­—ç¬¦ä¸²å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ‰èƒ½è§£ææˆåŠŸï¼š
//     - å­—ç¬¦ä¸²é‡Œé™¤äº†å‰ç¼€å¤–ï¼Œå…¶ä½™å­—ç¬¦çš„å–å€¼èŒƒå›´åªèƒ½åœ¨{0 1 2 3 4 5 6 7 8 9 a b c d e f A B C D E F}é‡Œ
//     - å®é™…ä¸Šï¼Œå°½ç®¡ç»™çš„å­—ç¬¦ä¸²æ˜¯16è¿›åˆ¶çš„ï¼Œä½†æ˜¯è§£æåå¾—åˆ°å¤§æ•´æ•°æ˜¯10è¿›åˆ¶å½¢å¼çš„ï¼Œå¦‚æœè§£æåçš„ç»“æœéœ€è¦è¶…è¿‡256ä½æ¯”ç‰¹å»å­˜å‚¨ï¼Œåˆ™è¯¥
//     æ–¹æ³•è®¤ä¸ºè§£æå¤±è´¥ï¼Œé»˜è®¤è§£æåæ‰€èƒ½è·å¾—çš„æœ€å¤§æ•´æ•°æ˜¯ï¼š
//     115792089237316195423570985008687907853269984665640564039457584007913129639935
//  2. å¦‚æœç»™å®šçš„å­—ç¬¦ä¸²ä¸å«æœ‰å‰ç¼€ï¼Œåˆ™ç»™å®šçš„å­—ç¬¦ä¸²å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ‰èƒ½è§£ææˆåŠŸï¼š
//     - å­—ç¬¦ä¸²é‡Œæ¯ä¸ªå­—ç¬¦çš„å–å€¼èŒƒå›´åªèƒ½åœ¨{0 1 2 3 4 5 6 7 8 9}é‡Œ
//     - è§£æåå¾—åˆ°çš„å¤§æ•´æ•°å¿…é¡»å°äº115792089237316195423570985008687907853269984665640564039457584007913129639935
//     ç»™å‡ºä¸¤ä¸ªä¾‹å­ï¼š
//     - è¾“å…¥"0x12a"ï¼Œå¾—åˆ°ï¼š298
//     - è¾“å…¥"123"ï¼Œå¾—åˆ°ï¼š123
func ParseBig256(s string) (*big.Int, bool) {
	if s == "" {
		return new(big.Int), true
	}
	var bigInt *big.Int
	var ok bool
	if len(s) >= 2 && (s[:2] == "0x" || s[:2] == "0X") {
		bigInt, ok = new(big.Int).SetString(s[2:], 16)
	} else {
		bigInt, ok = new(big.Int).SetString(s, 10)
	}
	if ok && bigInt.BitLen() > 256 {
		return nil, false
	}
	return bigInt, ok
}

// MustParseBig256 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•å®é™…ä¸Šå°±æ˜¯è°ƒç”¨ ParseBig256 æ–¹æ³•ï¼Œå¦‚æœ ParseBig256 æ— æ³•è§£æå­—ç¬¦ä¸²å¾—åˆ°å¤§æ•´æ•°ï¼Œåˆ™ç›´æ¥panicã€‚
func MustParseBig256(s string) *big.Int {
	result, ok := ParseBig256(s)
	if !ok {
		panic("invalid 256 bit integer: " + s)
	}
	return result
}

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// Decimal256 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// Decimal256 ç±»å‹çš„åº•å±‚å®ç°æ˜¯ big.Intï¼Œå®šä¹‰è¯¥ç±»å‹æ˜¯ä¸ºäº†å®ç°å¯¹å¤§æ•´æ•°çš„marshal/unmarshalï¼ŒDecimal256 å®ç°äº†
// MarshalText å’Œ UnmarshalText ä¸¤ä¸ªæ–¹æ³•ï¼ŒDecimal256 ä¸ HexOrDecimal256 ä¸åŒçš„åœ°æ–¹åœ¨äºï¼ŒDecimal256 çš„
// MarshalText æ–¹æ³•ä¸ä¼šæŠŠæ•°å­—ç¼–ç æˆ16è¿›åˆ¶å½¢å¼ï¼Œå³ä¸ä¼šå«æœ‰"0x"æˆ–"0X"å‰ç¼€ï¼›ä½†æ˜¯ Decimal256 æ”¯æŒå¯¹å«æœ‰å‰ç¼€çš„å­—èŠ‚
// åˆ‡ç‰‡è¿›è¡Œè§£ç ï¼Œå¹¶ä¸”è§£ç å¾—åˆ°çš„æ˜¯10è¿›åˆ¶çš„å¤§æ•´æ•°ã€‚
type Decimal256 big.Int

// NewDecimal256 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// NewDecimal256 æ–¹æ³•æ¥å—ä¸€ä¸ªint64ç±»å‹çš„æ•°å­—ä½œä¸ºå…¥å‚ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸º Decimal256 ç±»å‹ã€‚
func NewDecimal256(x int64) *Decimal256 {
	bigInt := big.NewInt(x)
	d := Decimal256(*bigInt)
	return &d
}

// MarshalText â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// MarshalText æ–¹æ³•å®ç°äº† encoding.TextMarshaler æ¥å£ï¼Œç›´æ¥ç»™æ•°å­—çš„ä¸¤ç«¯åŠ ä¸ŠåŒå¼•å·å¾—åˆ°å­—ç¬¦ä¸²ï¼Œ
// ç„¶åå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡å¹¶è¿”å›ã€‚
func (d *Decimal256) MarshalText() ([]byte, error) {
	return []byte(d.String()), nil
}

// UnmarshalText â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•å®ç°äº† encoding.TextUnmarshaler æ¥å£ï¼Œå°†ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡è½¬æ¢ä¸ºåè¿›åˆ¶çš„å¤§æ•´æ•°ï¼Œç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡éœ€è¦
// æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š
//   - å­—ç¬¦ä¸²é‡Œæ¯ä¸ªå­—ç¬¦çš„å–å€¼èŒƒå›´åªèƒ½åœ¨{0 1 2 3 4 5 6 7 8 9}é‡Œ
//   - è§£ç åå¾—åˆ°çš„å¤§æ•´æ•°å¿…é¡»å°äº115792089237316195423570985008687907853269984665640564039457584007913129639935
func (d *Decimal256) UnmarshalText(input []byte) error {
	bigInt, ok := ParseBig256(string(input))
	if !ok {
		return fmt.Errorf("invalid hex or decimal integer %q", input)
	}
	*d = Decimal256(*bigInt)
	return nil
}

// String â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•è¿”å› Decimal256 çš„å­—ç¬¦ä¸²å½¢å¼ã€‚
func (d *Decimal256) String() string {
	if d == nil {
		return "0"
	}
	return fmt.Sprintf("%#d", (*big.Int)(d))
}

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// BigPow â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªint64ç±»å‹çš„çš„å‚æ•°aå’Œbï¼Œç„¶åæ±‚r=a**bï¼Œå¹¶å°†rè½¬æ¢æˆå¤§æ•´æ•°å¹¶è¿”å›ã€‚
func BigPow(a, b int64) *big.Int {
	r := big.NewInt(a)
	return r.Exp(r, big.NewInt(b), nil)
}

// BigMax â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªå¤§æ•´æ•°xå’Œyï¼Œç„¶åè¿”å›è¿™ä¸¤ä¸ªæ•°ä¸­è¾ƒå¤§çš„é‚£ä¸€ä¸ªã€‚
func BigMax(x, y *big.Int) *big.Int {
	if x.Cmp(y) < 0 {
		return y
	}
	return x
}

// BigMin â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªå¤§æ•´æ•°xå’Œyï¼Œç„¶åè¿”å›è¿™ä¸¤ä¸ªæ•°ä¸­è¾ƒå°çš„é‚£ä¸€ä¸ªã€‚
func BigMin(x, y *big.Int) *big.Int {
	if x.Cmp(y) < 0 {
		return x
	}
	return y
}

// FirstBitSet â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå¤§æ•´æ•°ä½œä¸ºå…¥å‚ï¼Œè¯¥æ–¹æ³•ä»ç»™å®šçš„å¤§æ•´æ•°içš„æœ€ä½ä½å¼€å§‹éå†ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½ç­‰äº1çš„ä½ç½®ç»“æŸï¼Œ
// å¹¶è¿”å›è¯¥ä½ç½®å¤„çš„æ¯”ç‰¹ç´¢å¼•ä½ç½®ï¼ˆæœ€ä½æœ‰æ•ˆä½ï¼‰ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥å¤§æ•´æ•°çš„æ¯”ç‰¹é•¿åº¦ã€‚
//
//	ä¾‹å¦‚ï¼šç»™å®šä¸€ä¸ªå¤§æ•´æ•°ï¼š134348928ï¼Œå®ƒçš„äºŒè¿›åˆ¶è¡¨ç°å½¢å¼æ˜¯ï¼š0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0
//	å®ƒçš„æœ€ä½æœ‰æ•ˆä½åˆ™æ˜¯7ã€‚
func FirstBitSet(i *big.Int) int {
	for j := 0; j < i.BitLen(); j++ {
		if i.Bit(j) > 0 {
			return j
		}
	}
	return i.BitLen()
}

// ReadBits â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// ReadBits æ¥å—ä¸¤ä¸ªå…¥å‚ï¼Œç¬¬ä¸€ä¸ªå…¥å‚æ˜¯ä¸€ä¸ªå¤§æ•´æ•°bigIntï¼Œç¬¬äºŒä¸ªå…¥å‚æ˜¯ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡bufï¼Œè¯¥æ–¹çš„åŠŸèƒ½å°±æ˜¯å°†ç»™
// å®šçš„å¤§æ•´æ•°çš„æ‰€æœ‰æ¯”ç‰¹ä½æ‹·è´åˆ°ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡é‡Œï¼ˆä»bufçš„å³è¾¹å¼€å§‹æ‹·è´ï¼‰ï¼Œå¦‚æœç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡ä¸å¤Ÿé•¿ï¼Œå°±æ‹·è´
// len(buf)*8ä¸ªæ¯”ç‰¹ï¼›å¦‚æœå¤ªé•¿ï¼Œå­—èŠ‚åˆ‡ç‰‡å·¦è¾¹å‰©ä¸‹çš„å­—èŠ‚å°±ç½®ä¸º0.
func ReadBits(bigInt *big.Int, buf []byte) {
	i := len(buf)
	for _, word := range bigInt.Bits() {
		for j := 0; j < WordBytes && i > 0; j++ { // é€ä¸ªéå† big.Word é‡Œçš„æ¯ä¸ªå­—èŠ‚
			i--
			buf[i] = byte(word) // å– big.Word æœ€å³è¾¹çš„8ä¸ªæ¯”ç‰¹æ„æˆä¸€ä¸ªå­—èŠ‚
			word >>= 8          // å½“å‰ big.Word å³ç§»8ä¸ªæ¯”ç‰¹ä½
		}
	}
}

// PaddedBigBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// PaddedBigBytes è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå…¥å‚æ˜¯ä¸€ä¸ªå¤§æ•´æ•°bigIntï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•´æ•°nï¼Œè¯¥æ–¹æ³•çš„ç›®çš„
// å°±æ˜¯åœ¨ä¸æ”¹å˜bigIntå¤§å°çš„æƒ…å†µä¸‹ï¼Œç»™bigIntå¡«å……n-bigInt.BitLen()/8ä¸ªç©ºå­—èŠ‚ã€‚
//
//	ä¾‹å¦‚ï¼Œç»™å®šçš„å¤§æ•´æ•°bigInt=575648ï¼Œå®ƒçš„å­—èŠ‚åˆ‡ç‰‡è¡¨ç°å½¢å¼æ˜¯ï¼š[8 200 160]=[0001000 11001000 10100000]ï¼›
//	ç„¶åç»™å®šçš„nä¸º5ï¼Œé‚£ä¹ˆç»è¿‡å¡«å……åï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ï¼š[0 0 8 200 160]ã€‚
func PaddedBigBytes(bigInt *big.Int, n int) []byte {
	if bigInt.BitLen() >= n*8 {
		return bigInt.Bytes()
	}
	result := make([]byte, n)
	ReadBits(bigInt, result)
	return result
}

// bigEndianByteAt â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// bigEndianByteAt æ–¹æ³•æ¥å—ä¸¤ä¸ªå…¥å‚ï¼Œç¬¬ä¸€ä¸ªå…¥å‚æ˜¯ä¸€ä¸ªå¤§æ•´æ•°bigIntï¼Œç¬¬äºŒä¸ªå…¥å‚æ˜¯ä¸€ä¸ªæ•´æ•°nï¼Œè¯¥æ–¹æ³•çš„ç›®çš„æ˜¯è·
// å–bigIntä¸­ä»æœ€ä½ä½å­—èŠ‚å¼€å§‹ç¬¬nä¸ªå­—èŠ‚çš„å€¼ã€‚åœ¨è¿™é‡Œéœ€è¦æä¸€ä¸‹ï¼ŒbigInté‡Œå­—èŠ‚çš„ç¼–ç æ¨¡å¼æ˜¯å¤§ç«¯æ¨¡å¼ï¼Œå³é«˜ä½å­—èŠ‚å­˜
// æ”¾åœ¨ä½åœ°å€å¤„ï¼Œç¬¬nä¸ªå­—èŠ‚æ˜¯ä»ä½ä½å­—èŠ‚å¼€å§‹æ•°ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ç´¢å¼•å€¼æ˜¯0ï¼Œå®ƒæ˜¯å¤§æ•´æ•°é‡Œçš„æœ€ä½æœ‰æ•ˆå­—èŠ‚ï¼Œæ‰€ä»¥å½“nç­‰äº0æ—¶ï¼Œ
// è¯¥æ–¹æ³•ä¼šè¿”å›bigIntä¸­æœ€ä½ä½çš„å­—èŠ‚ï¼Œå³å­˜æ”¾åœ¨æœ€é«˜åœ°å€ä½ä¸Šçš„å­—èŠ‚ã€‚
//
//	ä¾‹å¦‚ï¼Œç»™å®šä¸€ä¸ªå¤§æ•´æ•°bigInt=20441799243135961136544514575630ï¼Œå®ƒçš„å­—èŠ‚åˆ‡ç‰‡è¡¨ç°å½¢å¼ä¸ºï¼š[1 2 3 4 5 6 7 8 9 10 11 12 13 14]ï¼Œ
//	åœ¨è¿™é‡Œï¼Œå­˜æ”¾14è¿™ä¸ªå­—èŠ‚çš„åœ°å€ä½æœ€é«˜ï¼Œè€Œ14è¿™ä¸ªå­—èŠ‚ä»£è¡¨çš„æ˜¯bigIntæœ€ä½æœ‰æ•ˆå­—èŠ‚ï¼›ç„¶åç»™å®šçš„nç­‰äº11ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œ
//	è¿”å›çš„å€¼ç­‰äºbyte(3)ã€‚
func bigEndianByteAt(bigInt *big.Int, n int) byte {
	words := bigInt.Bits()
	i := n / WordBytes
	if i >= len(words) {
		return byte(0)
	}
	word := words[i]
	shift := 8 * uint(n%WordBytes)
	return byte(word >> shift)
}

// Byte â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// Byte æ–¹æ³•æ¥å—ä¸‰ä¸ªå…¥å‚ï¼Œç¬¬ä¸€ä¸ªå…¥å‚æ˜¯ä¸€ä¸ªå¤§æ•´æ•°bigIntï¼Œç¬¬äºŒå’Œç¬¬ä¸‰ä¸¤ä¸ªå…¥å‚åˆ†åˆ«æ˜¯padLenå’Œnï¼Œéœ€è¦æ³¨æ„çš„æ˜¯padLenè¿™ä¸ªå‚æ•°ï¼Œ
// å®ƒè¡¨ç¤ºå¯¹åŸå§‹å¤§æ•´æ•°è¿›è¡Œå¡«å……åå¤§æ•´æ•°æ‰€å«æœ‰çš„å­—èŠ‚æ•°ï¼Œè¿™é‡ŒæŒ‡çš„å¡«å……å¯ä»¥è®¤ä¸ºæ˜¯è°ƒç”¨ PaddedBigBytes æ–¹æ³•å¯¹å¤§æ•´æ•°è¿›è¡Œå¡«å……ã€‚è¯¥
// æ–¹æ³•çš„ç›®çš„å°±æ˜¯è·å–bigIntä¸­ä»æœ€é«˜ä½å­—èŠ‚å¼€å§‹ç¬¬nä¸ªå­—èŠ‚çš„å€¼ï¼Œä¸ bigEndianByteAt è¿™ä¸ªæ–¹æ³•çš„ç›®çš„æ­£å¥½ç›¸åï¼Œå®é™…ä¸Šï¼ŒByte æ–¹
// æ³•å°±æ˜¯é€šè¿‡è°ƒç”¨ bigEndianByteAt æ–¹æ³•å®ç°çš„ï¼šreturn bigEndianByteAt(bigInt, padLen-1-n)
//
//	ä¾‹å¦‚ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªå¤§æ•´æ•°bigInt=4328719365ï¼Œå®ƒçš„å­—èŠ‚åˆ‡ç‰‡è¡¨ç°å½¢å¼æ˜¯ï¼š[1 2 3 4 5]ï¼Œè°ƒç”¨ PaddedBigBytes(bigInt, 17)
//	æ–¹æ³•å¯¹å…¶è¿›è¡Œå¡«å……ï¼Œä»bigIntçš„æœ€ä½åœ°å€ä½å¼€å§‹å¡«å……12ä¸ª0ï¼š[0 0 0 0 0 0 0 0 0 0 0 0 1 2 3 4 5]ï¼Œç„¶åç»™å®špadLen=17å’Œ
//	n=13ï¼Œè°ƒç”¨bigEndianByteAt(bigInt, 3)ï¼Œæ ¹æ® bigEndianByteAt çš„è§„åˆ™ä»æœ€ä½æœ‰æ•ˆå­—èŠ‚å¤„å¼€å§‹ï¼Œè¿”å›ç¬¬3ä¸ªå­—èŠ‚ï¼Œå³byte(2)ã€‚
func Byte(bigInt *big.Int, padLen, n int) byte {
	if n >= padLen {
		return byte(0)
	}
	return bigEndianByteAt(bigInt, padLen-1-n)
}

// U256 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// U256 è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå…¥å‚ï¼Œè¯¥å…¥å‚æ˜¯ä¸€ä¸ªå¤§æ•´æ•°xï¼Œç„¶åå°†xä¸ tt256m1 ä½œä¸è¿ç®—ï¼Œå¹¶å°†ç»“æœè¿”å›ã€‚
//
//		ä¾‹å¦‚ï¼šx=5ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•è¿”å›ï¼š5ã€‚
//	 ğŸš¨æ³¨æ„ï¼š*big.Int æœ‰ä¸¤ä¸ª Add(*big.Int) æ–¹æ³•ï¼ï¼ï¼å¹¶ä¸”è¿™ä¸¤ä¸ªæ–¹æ³•çš„åŠŸèƒ½ä¸ä¸€æ ·ï¼ï¼ï¼
func U256(x *big.Int) *big.Int {
	return x.And(x, tt256m1)
}

// U256Bytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// U256Bytes æ–¹æ³•å°†ä¸€ä¸ªç»™å®šçš„å¤§æ•´æ•°ï¼ˆæ¯”ç‰¹ä½å°äºç­‰äº256ï¼‰å¡«å……ä¸ºä¸€ä¸ªå«æœ‰32ä¸ªå­—èŠ‚çš„å¤§æ•´æ•°ï¼Œä»è€Œè½¬æ¢æˆä¹™å¤ªåŠè™šæ‹Ÿæœºé‡Œçš„æ”¯æŒçš„æ•°å­—ã€‚
//
//	ä¾‹å¦‚ï¼šç»™å®šçš„å¤§æ•´æ•°n=123ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•åå¾—åˆ°ç»“æœï¼š[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 123]
func U256Bytes(n *big.Int) []byte {
	return PaddedBigBytes(U256(n), 32)
}

// S256 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// S256 æ–¹æ³•æ¥å—ä¸€ä¸ªå¤§æ•´æ•°xä½œä¸ºå…¥å‚ï¼Œå¦‚æœxå°äº2^255ï¼Œåˆ™ç›´æ¥è¿”å›xï¼Œå¦åˆ™è®¡ç®—x-2^256ï¼Œå¹¶è¿”å›è®¡ç®—ç»“æœã€‚
//
//	ä¾‹å¦‚ï¼šç»™å®šçš„x=2^255+1ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•åå¾—åˆ°ç»“æœï¼š-57896044618658097711785492504343953926634992332820282019728792003956564819967
func S256(x *big.Int) *big.Int {
	if x.Cmp(tt255) < 0 {
		return x
	}
	return new(big.Int).Sub(x, tt256)
}

// Exp â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/28|
//
// Exp æ–¹æ³•æ¥å—ä¸¤ä¸ªå¤§æ•´æ•°baseå’Œexponentä½œä¸ºå…¥å‚ï¼Œç„¶åè®¡ç®—result=base^exponentï¼Œå¹¶å°†resultè¿”å›ã€‚
// å¦‚æœè®¡ç®—å¾—åˆ°çš„resultæ‰€è¡¨ç¤ºçš„æ•°éœ€è¦è¶…è¿‡256ä¸ªæ¯”ç‰¹ä½å­˜å‚¨ï¼Œé‚£ä¹ˆä»…ä¿ç•™ä½ä½çš„256ä¸ªæ¯”ç‰¹ã€‚
func Exp(base, exponent *big.Int) *big.Int {
	result := big.NewInt(1)
	for _, word := range exponent.Bits() {
		for i := 0; i < WordBytes; i++ {
			if word&1 == 1 {
				U256(result.Mul(result, base))
			}
			U256(base.Mul(base, base))
			word >>= 1
		}
	}
	return result
}
