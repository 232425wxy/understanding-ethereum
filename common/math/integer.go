/*
Package math

è¯¥æ–‡ä»¶ç±»å®šä¹‰äº†ä¸€ä¸ªç±»å‹ï¼šHexOrDecimal64ï¼Œè¯¥ç±»å‹çš„åœ°å±‚å®ç°æ˜¯uint64ï¼Œé€šè¿‡å®ƒå®ç°äº†å¯¹uint64è¿›è¡Œmarshal/unmarshalï¼Œmarshalä¼šå°†
64ä½æ— ç¬¦å·æ•´å‹ç¼–ç æˆå«æœ‰"0x"å‰ç¼€çš„16è¿›åˆ¶æ•°ï¼Œunmarshalæ”¯æŒå°†å«æœ‰"0x"æˆ–"0X"å‰ç¼€çš„16è¿›åˆ¶æ•°æˆ–è€…10è¿›åˆ¶æ•°è½¬æ¢æˆ64ä½æ— ç¬¦å·æ•´å‹ã€‚

æ­¤å¤–ï¼Œè¯¥æ–‡ä»¶è¿˜å®šä¹‰äº†å¦‚ä¸‹å…¨å±€å‡½æ•°ï¼š
  - func SafeSub(x, y uint64) (uint64, bool)
  - func SafeAdd(x, y uint64) (uint64, bool)
  - func SafeMul(x, y uint64) (uint64, bool)

ä»¥ä¸Šä¸‰ä¸ªå…¨å±€å‡½æ•°çš„ç¬¬äºŒä¸ªè¿”å›å€¼åæ˜ äº†å¯¹ä¸¤ä¸ª64ä½æ— ç¬¦å·æ•´å‹è¿›è¡ŒåŠ ã€å‡ä¹˜æ“ä½œåæ˜¯å¦ä¼šå‡ºç°æº¢å‡ºã€‚å¦‚æœæº¢å‡ºï¼Œåˆ™ç¬¬äºŒä¸ªè¿”å›å€¼ä¸ºtrueã€‚
*/
package math

import (
	"fmt"
	"math/bits"
	"strconv"
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

const (
	// MaxInt8 <=> 01111111
	MaxInt8 = 1<<7 - 1
	// MinInt8 <=> 10000000
	MinInt8 = -1 << 7
	// MaxInt16 <=> 01111111,11111111
	MaxInt16 = 1<<15 - 1
	// MinInt16 <=> 10000000,00000000
	MinInt16 = -1 << 15
	// MaxInt32 <=> 01111111,11111111,11111111,11111111
	MaxInt32 = 1<<31 - 1
	// MinInt32 <=> 10000000,00000000,00000000,00000000
	MinInt32 = -1 << 31
	// MaxInt64 <=> 01111111,11111111,11111111,11111111,11111111,11111111,11111111,11111111
	MaxInt64 = 1<<63 - 1
	// MinInt64 <=> 10000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000
	MinInt64 = -1 << 63
	// MaxUint8 <=> 11111111
	MaxUint8 = 1<<8 - 1
	// MaxUint16 <=> 11111111,11111111
	MaxUint16 = 1<<16 - 1
	// MaxUint32 <=> 11111111,11111111,11111111,11111111
	MaxUint32 = 1<<32 - 1
	// MaxUint64 <=> 11111111,11111111,11111111,11111111,11111111,11111111,11111111,11111111
	MaxUint64 = 1<<64 - 1
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// HexOrDecimal64 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/29|
//
// HexOrDecimal64 ç±»å‹çš„åº•å±‚æ˜¯uint64ç±»å‹ï¼Œ
type HexOrDecimal64 uint64

// MarshalText â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/29|
//
// è¯¥æ–¹æ³•å®ç°äº† encoding.TextMarshaler æ¥å£ï¼Œå®ç°å°†10è¿›åˆ¶æ•°è½¬æ¢æˆ16è¿›åˆ¶ï¼Œå¹¶åœ¨å‰é¢åŠ ä¸Š"0x"å‰ç¼€ã€‚
func (h HexOrDecimal64) MarshalText() ([]byte, error) {
	return []byte(fmt.Sprintf("%#x", uint64(h))), nil
}

// UnmarshalText â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/29|
//
// è¯¥æ–¹æ³•å®ç°äº† encoding.TextUnmarshaler æ¥å£ï¼Œè¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨ ParseUint64 æ–¹æ³•æ¥æŠŠç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡
// æ•°æ®è§£ææˆ64ä½çš„æ— ç¬¦å·æ•´æ•°ï¼Œæ”¯æŒè§£æå«æœ‰"0x"æˆ–"0X"å‰ç¼€çš„16è¿›åˆ¶æ•°ï¼Œä¹Ÿæ”¯æŒè§£æ10è¿›åˆ¶æ•°ã€‚
//
//	ä¾‹å¦‚ï¼šç»™å®šçš„string(input)="0x123"ï¼Œå¾—åˆ°æ•´æ•°ï¼š291ï¼›å¦‚æœç»™å®šçš„string(input)="123"ï¼Œå¾—åˆ°æ•´æ•°ï¼š123ã€‚
func (h *HexOrDecimal64) UnmarshalText(input []byte) error {
	i, ok := ParseUint64(string(input))
	if !ok {
		return fmt.Errorf("invalid hex or decimal integer %q", input)
	}
	*h = HexOrDecimal64(i)
	return nil
}

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// ParseUint64 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/29|
//
// ParseUint64 æ–¹æ³•æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°sï¼Œsåº”è¯¥æ˜¯ä¸€ä¸ªå«æœ‰"0x"æˆ–"0X"å‰ç¼€çš„16è¿›åˆ¶æ•°ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª10è¿›åˆ¶æ•°ï¼Œ
// ç„¶å ParseUint64 æ–¹æ³•å°†sè§£ææˆä¸€ä¸ªuint64ç±»å‹çš„10è¿›åˆ¶æ•´æ•°ã€‚å¦‚æœsçš„æ ¼å¼å­˜åœ¨é”™è¯¯ï¼Œè¯¥æ–¹æ³•è¿”å›çš„ç¬¬äºŒä¸ª
// å‚æ•°å°†ä¼šæ˜¯falseã€‚
//
//	ä¾‹å¦‚ï¼šç»™å®šçš„s="0x123"ï¼Œå¾—åˆ°æ•´æ•°ï¼š291ï¼›å¦‚æœç»™å®šçš„s="123"ï¼Œå¾—åˆ°æ•´æ•°ï¼š123ã€‚
func ParseUint64(s string) (uint64, bool) {
	if s == "" {
		return 0, true
	}
	if len(s) >= 2 && (s[:2] == "0x" || s[:2] == "0X") {
		result, err := strconv.ParseUint(s[2:], 16, 64)
		return result, err == nil
	}
	result, err := strconv.ParseUint(s, 10, 64)
	return result, err == nil
}

// MustParseUint64 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/29|
//
// MustParseUint64 æ–¹æ³•æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°sï¼Œsåº”è¯¥æ˜¯ä¸€ä¸ªå«æœ‰"0x"æˆ–"0X"å‰ç¼€çš„16è¿›åˆ¶æ•°ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª10è¿›åˆ¶æ•°ï¼Œ
// ç„¶å MustParseUint64 æ–¹æ³•å°†sè§£ææˆä¸€ä¸ªuint64ç±»å‹çš„10è¿›åˆ¶æ•´æ•°ã€‚è¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯å¯¹ ParseUint64 æ–¹æ³•çš„åŒ…
// è£…ï¼Œå¦‚æœ ParseUint64 çš„ç¬¬äºŒä¸ªå‚æ•°è¿”å›falseï¼Œåˆ™ MustParseUint64 ç›´æ¥panicã€‚
func MustParseUint64(s string) uint64 {
	result, ok := ParseUint64(s)
	if !ok {
		panic("invalid unsigned 64 bit integer: " + s)
	}
	return result
}

// SafeSub â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/29|
//
// è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ª64ä½æ— ç¬¦å·æ•´æ•°xå’Œyï¼Œç„¶åè®¡ç®—result=x-yï¼Œè¿”å›çš„resultä¹Ÿæ˜¯64ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¦‚æœè®¡ç®—ç»“æœæº¢å‡ºï¼Œ
// åˆ™è¯¥æ–¹æ³•è¿”å›çš„ç¬¬äºŒä¸ªå‚æ•°ç­‰äºtrueã€‚
//
//	ä¾‹å¦‚ï¼Œç»™å®šx=3ï¼Œy=5ï¼Œå¾—åˆ°è¾“å‡ºæ˜¯(18446744073709551614, true)ï¼›å†ç»™å®šx=3ï¼Œy=2ï¼Œå¾—åˆ°è¾“å‡ºæ˜¯(1, false)ã€‚
func SafeSub(x, y uint64) (uint64, bool) {
	diff, overflow := bits.Sub64(x, y, 0)
	return diff, overflow != 0
}

// SafeAdd â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/29|
//
// è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ª64ä½æ— ç¬¦å·æ•´æ•°xå’Œyï¼Œç„¶åè®¡ç®—result=x+yï¼Œè¿”å›çš„resultä¹Ÿæ˜¯64ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¦‚æœè®¡ç®—ç»“æœæº¢å‡ºï¼Œ
// åˆ™è¯¥æ–¹æ³•è¿”å›çš„ç¬¬äºŒä¸ªå‚æ•°ç­‰äºtrueã€‚
//
//	ä¾‹å¦‚ï¼Œç»™å®šx = MaxUint64 - 1ï¼Œy = 2ï¼Œå¾—åˆ°è¾“å‡ºæ˜¯(1, true)ï¼›å†ç»™å®šx = MaxUint64 - 1ï¼Œy = 1ï¼Œå¾—åˆ°
//	ç»“æœæ˜¯(18446744073709551615, false)ã€‚
func SafeAdd(x, y uint64) (uint64, bool) {
	result, overflow := bits.Add64(x, y, 0)
	return result, overflow != 0
}

// SafeMul â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/29|
//
// è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ª64ä½æ— ç¬¦å·æ•´æ•°xå’Œyï¼Œç„¶åè®¡ç®—result=x*yï¼Œè¿”å›çš„resultä¹Ÿæ˜¯64ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¦‚æœè®¡ç®—ç»“æœæº¢å‡ºï¼Œ
// åˆ™è¯¥æ–¹æ³•è¿”å›çš„ç¬¬äºŒä¸ªå‚æ•°ç­‰äºtrueã€‚
//
//	ä¾‹å¦‚ï¼Œç»™å®šx = MaxUint64 / 2ï¼Œy = 3ï¼Œå¾—åˆ°è¾“å‡ºæ˜¯(9223372036854775805, true)ï¼›å†ç»™å®šx = MaxUint64 / 2ï¼Œ
//	y = 2ï¼Œå¾—åˆ°ç»“æœæ˜¯(18446744073709551614, false)ã€‚
func SafeMul(x, y uint64) (uint64, bool) {
	overflow, result := bits.Mul64(x, y)
	return result, overflow != 0
}
