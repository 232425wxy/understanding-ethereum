package blake2b

import "math/bits"

// precomputed â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/16|
//
// precomputed å®šä¹‰äº†10ä¸ªé•¿åº¦ä¸º16çš„å­—èŠ‚æ•°æ•°ç»„ã€‚
var precomputed = [10][16]byte{
	{0, 2, 4, 6, 1, 3, 5, 7, 8, 10, 12, 14, 9, 11, 13, 15},
	{14, 4, 9, 13, 10, 8, 15, 6, 1, 0, 11, 5, 12, 2, 7, 3},
	{11, 12, 5, 15, 8, 0, 2, 13, 10, 3, 7, 9, 14, 6, 1, 4},
	{7, 3, 13, 11, 9, 1, 12, 14, 2, 5, 4, 15, 6, 10, 0, 8},
	{9, 5, 2, 10, 0, 7, 4, 15, 14, 11, 6, 3, 1, 12, 8, 13},
	{2, 6, 0, 8, 12, 10, 11, 3, 4, 7, 15, 1, 13, 5, 14, 9},
	{12, 1, 14, 4, 5, 15, 13, 10, 0, 6, 9, 8, 7, 3, 2, 11},
	{13, 7, 12, 3, 11, 14, 1, 9, 5, 15, 8, 2, 0, 4, 6, 10},
	{6, 14, 11, 0, 15, 9, 3, 8, 12, 13, 1, 10, 2, 7, 4, 5},
	{10, 8, 7, 1, 2, 4, 6, 5, 15, 9, 3, 13, 11, 14, 12, 0},
}

//fGeneric â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/16|
//
//fGeneric
func fGeneric(h *[8]uint64, m *[16]uint64, c0, c1 uint64, flag uint64, rounds uint64) {
	// å°†æ•°ç»„hä¸­çš„8ä¸ªå€¼åˆ†åˆ«éƒ½å–å‡ºæ¥
	v0, v1, v2, v3, v4, v5, v6, v7 := h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7]
	// å°†æ•°ç»„ivé‡Œçš„å€¼ä¹Ÿåˆ†åˆ«å–å‡ºæ¥ï¼Œæ•°ç»„ivé‡Œçš„æ¯ä¸ªå€¼éƒ½æ˜¯æ¯”è¾ƒå¤§çš„64ä½æ— ç¬¦å·æ•´æ•°
	v8, v9, v10, v11, v12, v13, v14, v15 := iv[0], iv[1], iv[2], iv[3], iv[4], iv[5], iv[6], iv[7]
	v12 ^= c0   // å°†v12ä¸c0åšå¼‚æˆ–è¿ç®—
	v13 ^= c1   // å°†v13ä¸c1åšå¼‚æˆ–è¿ç®—
	v14 ^= flag // å°†v14ä¸flagåšå¼‚æˆ–è¿ç®—

	for i := 0; i < int(rounds); i++ {
		// ç®€å•æ¥è¯´ï¼Œå–å‡ºprecomputedç¬¬(i%10)ä¸ªæ•°æ®çš„åœ°å€ï¼Œå¾€åå¦‚æœå¯¹sæŒ‡å‘çš„å­˜å‚¨ç©ºé—´é‡Œçš„å€¼è¿›è¡Œä¿®æ”¹ï¼Œåˆ™ä¼š
		// å½±å“precomputed[i%10]çš„å€¼
		// æ­¤å¤„ï¼ŒsæŒ‡å‘çš„å­˜å‚¨ç©ºé—´é‡Œå­˜å‚¨çš„æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º16çš„å­—èŠ‚æ•°ç»„
		s := &(precomputed[i%10])

		// v0åŠ ä¸Šmé‡Œçš„ç¬¬s[0]ä¸ªå€¼ï¼Œä¹‹åå†åŠ ä¸Šv4
		v0 += m[s[0]]
		v0 += v4
		// v12å…ˆä¸v0åšå¼‚æˆ–è¿ç®—ï¼Œç„¶åå†è®©ï¼šv12 = v12 << 32 | v12 >> 32
		v12 ^= v0
		v12 = bits.RotateLeft64(v12, -32)
		// v8åŠ ä¸Šv12ï¼Œå†å°†v4ä¸v8åšå¼‚æˆ–è¿ç®—ï¼Œæœ€åï¼šv4 = v4 << 40 | v4 >> 24
		v8 += v12
		v4 ^= v8
		v4 = bits.RotateLeft64(v4, -24)
		// sæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º16çš„æ•°ç»„ï¼Œè®©v1åŠ ä¸Šmçš„ç¬¬s[1]ä¸ªå€¼ï¼Œç„¶åå†è®©v1åŠ ä¸Šv5
		v1 += m[s[1]]
		v1 += v5
		// è®©v13ä¸v1åšå¼‚æˆ–è¿ç®—ï¼Œç„¶åï¼šv13 = v13 << 32 | v13 >> 32
		v13 ^= v1
		v13 = bits.RotateLeft64(v13, -32)
		// è®©v9åŠ ä¸Šv13ï¼Œç„¶åè®©v5ä¸v9åšå¼‚æˆ–è¿ç®—ï¼Œæ¥ç€ï¼šv5 = v5 << 40 | v5 >> 24
		v9 += v13
		v5 ^= v9
		v5 = bits.RotateLeft64(v5, -24)
		//
		v2 += m[s[2]]
		v2 += v6
		v14 ^= v2
		v14 = bits.RotateLeft64(v14, -32)
		v10 += v14
		v6 ^= v10
		v6 = bits.RotateLeft64(v6, -24)
		v3 += m[s[3]]
		v3 += v7
		v15 ^= v3
		v15 = bits.RotateLeft64(v15, -32)
		v11 += v15
		v7 ^= v11
		v7 = bits.RotateLeft64(v7, -24)

		v0 += m[s[4]]
		v0 += v4
		v12 ^= v0
		v12 = bits.RotateLeft64(v12, -16)
		v8 += v12
		v4 ^= v8
		v4 = bits.RotateLeft64(v4, -63)
		v1 += m[s[5]]
		v1 += v5
		v13 ^= v1
		v13 = bits.RotateLeft64(v13, -16)
		v9 += v13
		v5 ^= v9
		v5 = bits.RotateLeft64(v5, -63)
		v2 += m[s[6]]
		v2 += v6
		v14 ^= v2
		v14 = bits.RotateLeft64(v14, -16)
		v10 += v14
		v6 ^= v10
		v6 = bits.RotateLeft64(v6, -63)
		v3 += m[s[7]]
		v3 += v7
		v15 ^= v3
		v15 = bits.RotateLeft64(v15, -16)
		v11 += v15
		v7 ^= v11
		v7 = bits.RotateLeft64(v7, -63)

		v0 += m[s[8]]
		v0 += v5
		v15 ^= v0
		v15 = bits.RotateLeft64(v15, -32)
		v10 += v15
		v5 ^= v10
		v5 = bits.RotateLeft64(v5, -24)
		v1 += m[s[9]]
		v1 += v6
		v12 ^= v1
		v12 = bits.RotateLeft64(v12, -32)
		v11 += v12
		v6 ^= v11
		v6 = bits.RotateLeft64(v6, -24)
		v2 += m[s[10]]
		v2 += v7
		v13 ^= v2
		v13 = bits.RotateLeft64(v13, -32)
		v8 += v13
		v7 ^= v8
		v7 = bits.RotateLeft64(v7, -24)
		v3 += m[s[11]]
		v3 += v4
		v14 ^= v3
		v14 = bits.RotateLeft64(v14, -32)
		v9 += v14
		v4 ^= v9
		v4 = bits.RotateLeft64(v4, -24)

		v0 += m[s[12]]
		v0 += v5
		v15 ^= v0
		v15 = bits.RotateLeft64(v15, -16)
		v10 += v15
		v5 ^= v10
		v5 = bits.RotateLeft64(v5, -63)
		v1 += m[s[13]]
		v1 += v6
		v12 ^= v1
		v12 = bits.RotateLeft64(v12, -16)
		v11 += v12
		v6 ^= v11
		v6 = bits.RotateLeft64(v6, -63)
		v2 += m[s[14]]
		v2 += v7
		v13 ^= v2
		v13 = bits.RotateLeft64(v13, -16)
		//
		v8 += v13
		v7 ^= v8
		v7 = bits.RotateLeft64(v7, -63)
		// è®©v3åŠ ä¸Šmçš„ç¬¬s[15]ä¸ªå€¼ï¼Œç„¶åè®©v3åŠ ä¸Šv4ï¼Œæ¥ç€è®©v14ä¸v3åšå¼‚æˆ–è¿ç®—ï¼Œæœ€åï¼šv14 = v14 << 48 | v14 >> 16
		v3 += m[s[15]]
		v3 += v4
		v14 ^= v3
		v14 = bits.RotateLeft64(v14, -16)
		// è®©v9åŠ ä¸Šv14ï¼Œæ¥ç€è®©v4ä¸v9åšå¼‚æˆ–è¿ç®—ï¼Œç„¶åï¼šv4 = v4 << 1 || v4 >> 63
		v9 += v14
		v4 ^= v9
		v4 = bits.RotateLeft64(v4, -63)
	}
	h[0] ^= v0 ^ v8
	h[1] ^= v1 ^ v9
	h[2] ^= v2 ^ v10
	h[3] ^= v3 ^ v11
	h[4] ^= v4 ^ v12
	h[5] ^= v5 ^ v13
	h[6] ^= v6 ^ v14
	h[7] ^= v7 ^ v15
}
