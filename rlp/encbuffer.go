package rlp

import (
	"github.com/232425wxy/understanding-ethereum/common/math"
	"io"
	"math/big"
	"sync"
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// encBuffer â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/30|
//
// encBuffer ç»“æ„ä½“è¢«ç”¨äºåœ¨ç¼–ç æ•°æ®æ—¶å­˜å‚¨ç¼–ç ç»“æœã€‚
type encBuffer struct {
	str          []byte     // str åŒ…å«äº†é™¤åˆ—è¡¨å¤´ä¹‹å¤–çš„æ‰€æœ‰ç¼–ç ä¿¡æ¯
	lHeads       []listHead // å­˜å‚¨äº†æ‰€æœ‰åˆ—è¡¨å¤´ä¿¡æ¯ï¼Œå®˜æ–¹æºç çš„å†™æ³•æ˜¯"lheads"
	lHeadsSize   int        // å®˜æ–¹æºç å†™æ³•æ˜¯"lhsize"ï¼Œè¡¨ç¤ºæ‰€æœ‰å¤´åŠ ä¸€èµ·çš„é•¿åº¦
	auxiliaryBuf [9]byte    // å®˜æ–¹æºç å†™æ³•æ˜¯"sizebuf"
}

// encBufferPool â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// encBufferPool æ˜¯ä¸€ä¸ªå…¨å±€æ± å­ï¼Œæˆ‘ä»¬å¯ä»¥ä»é‡Œé¢æ‹¿åˆ°ä¸€ä¸ª encBuffer å®ä¾‹ï¼Œæ¯æ¬¡ä»è¿™ä¸ªæ± å­é‡Œæ‹¿ä¸€ä¸ª encBuffer ä¹‹åï¼Œ
// å¦‚æœä¸æ”¾å›å»ï¼Œé‚£ä¹ˆä¸‹æ¬¡å†æ‹¿çš„è¯å°±ä¸æ˜¯æˆ‘ä»¬åˆšåˆšæ‹¿çš„é‚£ä¸ª encBuffer äº†ï¼Œé™¤éæˆ‘ä»¬æ‹¿äº†ç”¨å®Œä¹‹ååœ¨ç»™å®ƒæ”¾å›å»ã€‚
var encBufferPool = sync.Pool{New: func() interface{} { return new(encBuffer) }}

// getEncBuffer â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// getEncBuffer æ–¹æ³•ä» encBufferPool æ± é‡Œæ‹¿å‡ºä¸€ä¸ª encBuffer å®ä¾‹ã€‚
func getEncBuffer() *encBuffer {
	buf := encBufferPool.Get().(*encBuffer)
	buf.reset()
	return buf
}

// reset â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// è¯¥æ–¹æ³•ä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç æ¥é‡ç½® encBufferï¼š
//
//	buf.lHeadsSize = 0
//	buf.str = buf.str[:0]
//	buf.lHeads = buf.lHeads[:0]
func (buf *encBuffer) reset() {
	buf.lHeadsSize = 0
	buf.str = buf.str[:0]
	buf.lHeads = buf.lHeads[:0]
}

// size â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// size æ–¹æ³•è¿”å›å·²ç¼–ç æ•°æ®çš„é•¿åº¦ï¼šlen(encBuffer.str)+encBuffer.lHeadsSizeï¼Œè¯¥æ–¹æ³•è¿”å›çš„å€¼å°±æ˜¯ç¼–ç æ•°æ®çš„
// ç»“æœçš„å®Œæ•´é•¿åº¦ï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æ˜¯dataï¼Œç¼–ç åçš„ç»“æœæ˜¯resultï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•è¿”å›çš„ç»“æœç›¸å½“äºlen(result)ï¼Œ
func (buf *encBuffer) size() int {
	return len(buf.str) + buf.lHeadsSize
}

// makeBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// makeBytes æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†ç¼–ç ç»“æœå®Œæ•´çš„è¿”å›å‡ºæ¥ã€‚
func (buf *encBuffer) makeBytes() []byte {
	result := make([]byte, buf.size())
	buf.copyTo(result)
	return result
}

// copyTo â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// copyTo æ–¹æ³•æ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡å‚æ•°bufï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯å°† encBuffer å†…å­˜å‚¨çš„ç¼–ç æ•°æ®æ‹·è´åˆ°bufé‡Œï¼ŒåŒæ—¶è¿˜éœ€è¦é…åˆ
// encBuffer.lHeads å­—æ®µå°†åˆ—è¡¨å¤´æˆ–è€…ç¼–ç çš„æ•°æ®å¤´ç¼–ç åˆ°bufé‡Œã€‚
func (buf *encBuffer) copyTo(dst []byte) {
	strPos := 0
	pos := 0
	for _, head := range buf.lHeads {
		// ç¬¬ä¸€ä¸ªheadçš„offsetå¿…ç­‰äº0ï¼Œbuf.str[strPos:head.offset]è¡¨ç¤ºå‰ä¸€ä¸ªåˆ—è¡¨å¤´åˆ°å½“å‰åˆ—è¡¨å¤´ä¹‹é—´çš„å­—ç¬¦ä¸²
		n := copy(dst[pos:], buf.str[strPos:head.offset])
		pos += n
		strPos += n
		enc := head.encodeHead(dst[pos:])
		pos += len(enc)
	}
	// ä¸‹é¢è¿™å¥å¾ˆå…³é”®ï¼Œå¦‚æœæˆ‘ä»¬ç¼–ç çš„æ•°æ®å®Œå…¨æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä¸Šé¢çš„forå¾ªç¯æ ¹æœ¬ä¸ä¼šæ‰§è¡Œï¼Œé‚£ä¹ˆä¸‹é¢è¿™æ®µä»£ç å°±å¯ä»¥å°†ç¼–ç çš„
	// å­—ç¬¦ä¸²æ•°æ®æ‹·è´å‡ºæ¥ï¼›è€Œå¦‚æœæˆ‘ä»¬ç¼–ç çš„æ•°æ®æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œé‚£ä¹ˆä¸‹é¢è¿™è¡Œä»£ç å¯ä»¥å°†æœ€åä¸€ä¸ªå¤´åé¢è·Ÿç€çš„ç¼–ç æ•°æ®æ‹·è´å‡ºæ¥
	copy(dst[pos:], buf.str[strPos:])
}

// writeTo â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeTo æ–¹æ³•æ¥å—ä¸€ä¸ª io.Writer å‚æ•°ï¼Œè¯¥æ–¹æ³•å°†ç¼–ç ç»“æœå®Œæ•´åœ°å†™å…¥åˆ°ç»™å®šçš„ io.Writer é‡Œï¼Œå®˜æ–¹çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š
//
//	strpos := 0
//	for _, head := range buf.lHeads {
//		// write string data before header
//		if head.offset-strpos > 0 {
//			n, err := w.Write(buf.str[strpos:head.offset])
//			strpos += n
//			if err != nil {
//			return err
//			}
//		}
//		// write the header
//		enc := head.encodeHead(buf.auxiliaryBuf[:])
//		if _, err = w.Write(enc); err != nil {
//			return err
//		}
//	}
//	if strpos < len(buf.str) {
//		// write string data after the last list header
//		_, err = w.Write(buf.str[strpos:])
//	}
//	return err
//
// æˆ‘å¯¹å®˜æ–¹çš„å®ç°è¿›è¡Œäº†ç®€åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬å‰é¢çš„ makeBytes æ–¹æ³•å°±å¯ä»¥è·å¾—å®Œæ•´çš„ç¼–ç ç»“æœï¼Œä½•æ•…å†åˆ©ç”¨ä¸€ä¸ªæ–°çš„é€»è¾‘å»è·å–ç¼–ç ç»“æœå‘¢ï¼Ÿ
func (buf *encBuffer) writeTo(w io.Writer) error {
	bz := buf.makeBytes()
	if _, err := w.Write(bz); err != nil {
		return err
	}
	return nil
}

// Write â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// Write æ–¹æ³•å®ç°äº† io.Writer æ¥å£ï¼Œè¯¥æ–¹æ³•ç›´æ¥å°†ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡è¿½åŠ åˆ° encBuffer.str åé¢ã€‚è¿”å›å€¼æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªè¿”å›å€¼è¡¨ç¤º
// ç»™å®šåˆ‡ç‰‡çš„é•¿åº¦ï¼Œç¬¬äºŒä¸ªè¿”å›å€¼æ°¸è¿œä¸ºnilã€‚
func (buf *encBuffer) Write(bz []byte) (int, error) {
	buf.str = append(buf.str, bz...)
	return len(bz), nil
}

// writeBool â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeBool è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªboolç±»å‹çš„å˜é‡ï¼Œç„¶åæ ¹æ®å…¶å€¼å°†å…¶ç¼–ç åˆ° encBuffer.str é‡Œï¼Œå¦‚æœç»™çš„å€¼ç­‰äºtrueï¼Œé‚£ä¹ˆå°±å¾€stré‡Œå†™
// å…¥0x01ï¼Œå¦åˆ™å†™å…¥0x80ï¼Œ0x80è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªç©ºå€¼ã€‚
func (buf *encBuffer) writeBool(b bool) {
	if b {
		buf.str = append(buf.str, 0x01)
	} else {
		buf.str = append(buf.str, 0x80)
	}
}

// writeUint64 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeUint64 æ–¹æ³•æ¥å—ä¸€ä¸ª64ä½çš„æ— ç¬¦å·æ•´æ•°ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œç„¶åå°†å…¶ç¼–ç åˆ° encBuffer.str é‡Œï¼Œå¦‚æœè¾“å…¥çš„æ•´æ•°å¤§å°å°äº128ï¼Œåˆ™å¯
// ä»¥å°†å…¶çœ‹æˆæ˜¯ä¸€ä¸ªå•ç‹¬çš„ASCIIç ï¼Œé‚£ä¹ˆè¯¥æ•´æ•°è‡ªèº«å°±å¯ä»¥ä½œä¸ºç¼–ç ç»“æœå†™å…¥åˆ°stré‡Œï¼›å¦‚æœç»™å®šçš„æ•´æ•°å¤§äºæˆ–ç­‰äº128ï¼Œåˆ™ä¼šè®¡ç®—éœ€è¦å¤šå°‘ä¸ª
// å­—èŠ‚æ‰èƒ½å­˜å‚¨è¿™ä¸ªæ•°ï¼Œä¾‹å¦‚éœ€è¦nä¸ªï¼Œé‚£ä¹ˆç¼–ç ç»“æœå°±æ˜¯ï¼ˆ0x80+n||æ•´æ•°çš„å­—èŠ‚è¡¨ç°å½¢å¼ï¼‰ï¼›å¦‚æœç»™å®šçš„æ•´æ•°ç­‰äº0ï¼Œåˆ™å°†0x80å†™å…¥åˆ°stré‡Œï¼Œ
// ä»£è¡¨ç©ºå€¼ï¼Œä¸‹é¢ç»™å‡ºä¸‰ä¸ªç¤ºä¾‹æ¥å¯¹è¯¥æ–¹æ³•çš„é€»è¾‘è¿›è¡Œè§£é‡Šï¼š
//   - 0ï¼šappend(str, 0x80)
//   - 123ï¼šappend(str, byte(123))
//   - 1024ï¼šappend(str, []byte{0x80+2, 000000100, 00000000})
func (buf *encBuffer) writeUint64(i uint64) {
	if i == 0 {
		buf.str = append(buf.str, 0x80)
	} else if i < 128 {
		buf.str = append(buf.str, byte(i))
	} else {
		n := putInt(buf.auxiliaryBuf[1:], i)
		buf.auxiliaryBuf[0] = 0x80 + byte(n)
		buf.str = append(buf.str, buf.auxiliaryBuf[:1+n]...)
	}
}

// writeBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeBytes æ–¹æ³•æ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡bzï¼Œè¯¥æ–¹æ³•çš„ç›®çš„å°±æ˜¯å°†å­—èŠ‚åˆ‡ç‰‡bzç¼–ç åˆ° encBuffer.str é‡Œã€‚å½“bzæ»¡è¶³ä¸åŒæƒ…å†µæ—¶ï¼Œç¼–ç æ–¹å¼ä¹Ÿä¸
// åŒï¼Œå…·ä½“ä¼šé‡åˆ°ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š
//   - ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡bzé•¿åº¦ç­‰äº1ï¼Œå¹¶ä¸”é‡Œé¢å”¯ä¸€çš„å­—èŠ‚å°äºæˆ–ç­‰äº0x7Fï¼Œå³127ï¼Œé‚£ä¹ˆè¯¥å­—èŠ‚åˆ‡ç‰‡ï¼ˆæˆ–è€…è¯´è¯¥å­—èŠ‚æ›´å‡†ç¡®ï¼‰ä¼šè¢«ç›´æ¥è¿½åŠ åˆ°strå
//   - ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡é•¿åº¦å¤§äº1ï¼Œé‚£ä¹ˆä¼šå°†bzçš„é•¿åº¦å…ˆç¼–ç åˆ°stré‡Œï¼Œè¿™é‡Œåˆä¼šé‡åˆ°ä¸¤ç§æƒ…å†µï¼š1.é•¿åº¦å°äº56ï¼›2.é•¿åº¦å¤§äº55ã€‚é¢å¯¹ä¸åŒçš„æƒ…å†µï¼Œ
//     å¦‚ä½•å¯¹å­—èŠ‚é•¿åº¦è¿›è¡Œç¼–ç å¿…é¡»éµå®ˆä»¥ä¸‹å‡†åˆ™ï¼š
//     Â· å½“é•¿åº¦sizeå°äº56ï¼Œåˆ™å°†0x80+sizeçš„å€¼è¿½åŠ åˆ°strå
//     Â· å½“é•¿åº¦sizeå¤§äº55ï¼Œä¾‹å¦‚1024ï¼Œå­˜å‚¨1024æœ€å°‘éœ€è¦2ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«æ˜¯00000100å’Œ00000000ï¼Œé‚£ä¹ˆå°±å°†0xB7+2å’Œè¿™
//     ä¸¤ä¸ªå­—èŠ‚è¿½åŠ åˆ°strå
//     å­—èŠ‚çš„é•¿åº¦è¢«ç¼–ç åˆ°stré‡Œåï¼Œå‰©ä¸‹çš„å·¥ä½œåˆ™æ˜¯ç›´æ¥å°†åˆ‡ç‰‡bzè¿½åŠ åˆ°stråã€‚
func (buf *encBuffer) writeBytes(bz []byte) {
	if len(bz) == 1 && bz[0] < 0x80 {
		buf.str = append(buf.str, bz[0])
	} else {
		// å…ˆæŠŠå­—èŠ‚åˆ‡ç‰‡çš„é•¿åº¦ç¼–ç äº†
		buf.encodeStringHeader(len(bz))
		// å‰©ä¸‹çš„å°±æ˜¯ç›´æ¥å°†å­—èŠ‚åˆ‡ç‰‡è¿½åŠ åˆ°stråé¢
		buf.str = append(buf.str, bz...)
	}
}

// writeString â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeString æ–¹æ³•æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°sï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†sç¼–ç åˆ° encBuffer.str é‡Œï¼Œå®é™…ä¸Šï¼Œè¯¥æ–¹æ³•çš„é€»è¾‘æ˜¯è°ƒç”¨äº†å¦‚ä¸‹å‡½æ•°ï¼Œæ¥å®ç°
// å°†sç¼–ç åˆ°stré‡Œï¼š
//
//	buf.writeBytes([]byte(s))
func (buf *encBuffer) writeString(s string) {
	buf.writeBytes([]byte(s))
}

// writeBigInt â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeBigInt æ–¹æ³•æ¥å—ä¸€ä¸ªå¤§æ•´æ•°iï¼Œiçš„ç±»å‹æ˜¯*big.Intï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†å¤§æ•´æ•°ç¼–ç åˆ° encBuffer.str é‡Œã€‚äº‹å®ä¸Šï¼Œå¤§æ•´æ•°ä¸ä¸€å®šå°±æ¯”
// æœ€å¤§çš„64ä½æ— ç¬¦å·æ•´æ•°å¤§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ writeUint64 æ–¹æ³•å°†è¯¥æ‰€è°“çš„å¤§æ•´æ•°ç¼–ç åˆ°stré‡Œï¼›ä½†æ˜¯ï¼Œå¦‚æœç»™å®šçš„å¤§æ•´æ•°å¤§äºæœ€å¤§çš„64
// ä½æ— ç¬¦å·æ•´æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶çœ‹æˆæ˜¯ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡è¿›è¡Œç¼–ç ï¼Œæ­¤æ—¶è¯¥å¤§æ•´æ•°éœ€è¦è¶…è¿‡8ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹å®˜æ–¹çš„æºç ä½œä¸ºä¸€äº›æ”¹
// åŠ¨ï¼Œç»è¿‡æµ‹è¯•ï¼Œæ”¹åŠ¨åçš„æ•ˆæœå’Œå®˜æ–¹æºç ä¸€æ ·ã€‚
func (buf *encBuffer) writeBigInt(i *big.Int) {
	if i.BitLen() <= 64 {
		buf.writeUint64(i.Uint64())
		return
	}
	// è®¡ç®—è¯¥å¤§æ•´æ•°éœ€è¦å¤šå°‘ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼Œè¿™é‡Œå®˜æ–¹çš„è®¡ç®—æ–¹å¼æ˜¯ï¼š
	// n := ((i.BitLen() + 7) & -8) >> 3
	// ä¸æ‡‚ä¸ºä½•è¦è¿™æ ·å†™ï¼Œæ˜¾å¾—æ›´é«˜çº§ï¼Ÿ
	n := (i.BitLen() + 7) / 8
	buf.encodeStringHeader(n)
	enc, index := make([]byte, n), n
	for _, word := range i.Bits() {
		for j := 0; j < math.WordBytes && index > 0; j++ {
			index--
			enc[index] = byte(word)
			word >>= 8
		}
	}
	buf.str = append(buf.str, enc...)
}

// encodeStringHeader â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// encodeStringHeader æ–¹æ³•æ¥å—ä¸€ä¸ªæ•´å‹sizeä½œä¸ºè¾“å…¥ï¼Œé¡¾åæ€ä¹‰ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯åœ¨ç¼–ç å­—ç¬¦ä¸²æ•°æ®æ—¶ï¼Œå°†å­—ç¬¦ä¸²çš„é•¿åº¦ç¼–ç åˆ° encBuffer.str
// é‡Œï¼Œè¯¥æ–¹æ³•ä»…åœ¨ç¼–ç é•¿åº¦å¤§äº1çš„å­—ç¬¦ä¸²æˆ–è€…å­—èŠ‚åˆ‡ç‰‡æ—¶æ‰ä¼šè¢«ä½¿ç”¨ã€‚ç¼–ç æ—¶ï¼Œéœ€è¦éµå®ˆä»¥ä¸‹ä¸¤æ¡è§„åˆ™ï¼š
//
//	Â· å½“é•¿åº¦sizeå°äº56ï¼Œåˆ™å°†0x80+sizeçš„å€¼è¿½åŠ åˆ°strå
//	Â· å½“é•¿åº¦sizeå¤§äº55ï¼Œä¾‹å¦‚1024ï¼Œå­˜å‚¨1024æœ€å°‘éœ€è¦2ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«æ˜¯00000100å’Œ00000000ï¼Œé‚£ä¹ˆå°±å°†0xB7+2å’Œè¿™
//	  ä¸¤ä¸ªå­—èŠ‚è¿½åŠ åˆ°strå
func (buf *encBuffer) encodeStringHeader(size int) {
	if size < 56 {
		buf.str = append(buf.str, 0x80+byte(size))
	} else {
		n := putInt(buf.auxiliaryBuf[1:], uint64(size))
		buf.auxiliaryBuf[0] = 0xB7 + byte(n)
		buf.str = append(buf.str, buf.auxiliaryBuf[:1+n]...)
	}
}
