package rlp

import (
	"github.com/232425wxy/understanding-ethereum/common/math"
	"io"
	"math/big"
	"reflect"
	"sync"
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// encBuffer â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/30|
//
// encBuffer ç»“æ„ä½“è¢«ç”¨äºåœ¨ç¼–ç æ•°æ®æ—¶å­˜å‚¨ç¼–ç ç»“æœã€‚
type encBuffer struct {
	str          []byte     // str åŒ…å«äº†é™¤åˆ—è¡¨å¤´ä¹‹å¤–çš„æ‰€æœ‰ç¼–ç ä¿¡æ¯
	lHeads       []listHead // å­˜å‚¨äº†æ‰€æœ‰åˆ—è¡¨å¤´ä¿¡æ¯ï¼Œå®˜æ–¹æºç çš„å†™æ³•æ˜¯"lheads"
	lHeadsSize   int        // å®˜æ–¹æºç å†™æ³•æ˜¯"lhsize"ï¼Œè¡¨ç¤ºæ‰€æœ‰å¤´åŠ ä¸€èµ·çš„é•¿åº¦
	auxiliaryBuf [9]byte    // å®˜æ–¹æºç å†™æ³•æ˜¯"sizebuf"
}

// encBufferPool â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// encBufferPool æ˜¯ä¸€ä¸ªå…¨å±€æ± å­ï¼Œæˆ‘ä»¬å¯ä»¥ä»é‡Œé¢æ‹¿åˆ°ä¸€ä¸ª encBuffer å®ä¾‹ï¼Œæ¯æ¬¡ä»è¿™ä¸ªæ± å­é‡Œæ‹¿ä¸€ä¸ª encBuffer ä¹‹åï¼Œ
// å¦‚æœä¸æ”¾å›å»ï¼Œé‚£ä¹ˆä¸‹æ¬¡å†æ‹¿çš„è¯å°±ä¸æ˜¯æˆ‘ä»¬åˆšåˆšæ‹¿çš„é‚£ä¸ª encBuffer äº†ï¼Œé™¤éæˆ‘ä»¬æ‹¿äº†ç”¨å®Œä¹‹ååœ¨ç»™å®ƒæ”¾å›å»ã€‚
var encBufferPool = sync.Pool{New: func() interface{} { return new(encBuffer) }}

// getEncBuffer â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// getEncBuffer æ–¹æ³•ä» encBufferPool æ± é‡Œæ‹¿å‡ºä¸€ä¸ª encBuffer å®ä¾‹ã€‚
func getEncBuffer() *encBuffer {
	buf := encBufferPool.Get().(*encBuffer)
	buf.reset()
	return buf
}

// reset â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// è¯¥æ–¹æ³•ä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç æ¥é‡ç½® encBufferï¼š
//
//	buf.lHeadsSize = 0
//	buf.str = buf.str[:0]
//	buf.lHeads = buf.lHeads[:0]
func (buf *encBuffer) reset() {
	buf.lHeadsSize = 0
	buf.str = buf.str[:0]
	buf.lHeads = buf.lHeads[:0]
}

// size â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// size æ–¹æ³•è¿”å›å·²ç¼–ç æ•°æ®çš„é•¿åº¦ï¼šlen(encBuffer.str)+encBuffer.lHeadsSizeï¼Œè¯¥æ–¹æ³•è¿”å›çš„å€¼å°±æ˜¯ç¼–ç æ•°æ®çš„
// ç»“æœçš„å®Œæ•´é•¿åº¦ï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æ˜¯dataï¼Œç¼–ç åçš„ç»“æœæ˜¯resultï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•è¿”å›çš„ç»“æœç›¸å½“äºlen(result)ï¼Œ
func (buf *encBuffer) size() int {
	return len(buf.str) + buf.lHeadsSize
}

// makeBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// makeBytes æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†ç¼–ç ç»“æœå®Œæ•´çš„è¿”å›å‡ºæ¥ã€‚
func (buf *encBuffer) makeBytes() []byte {
	result := make([]byte, buf.size())
	buf.copyTo(result)
	return result
}

// copyTo â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// copyTo æ–¹æ³•æ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡å‚æ•°bufï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯å°† encBuffer å†…å­˜å‚¨çš„ç¼–ç æ•°æ®æ‹·è´åˆ°bufé‡Œï¼ŒåŒæ—¶è¿˜éœ€è¦é…åˆ
// encBuffer.lHeads å­—æ®µå°†åˆ—è¡¨å¤´æˆ–è€…ç¼–ç çš„æ•°æ®å¤´ç¼–ç åˆ°bufé‡Œã€‚
func (buf *encBuffer) copyTo(dst []byte) {
	strPos := 0
	pos := 0
	for _, head := range buf.lHeads {
		// ç¬¬ä¸€ä¸ªheadçš„offsetå¿…ç­‰äº0ï¼Œbuf.str[strPos:head.offset]è¡¨ç¤ºå‰ä¸€ä¸ªåˆ—è¡¨å¤´åˆ°å½“å‰åˆ—è¡¨å¤´ä¹‹é—´çš„å­—ç¬¦ä¸²
		n := copy(dst[pos:], buf.str[strPos:head.offset])
		pos += n
		strPos += n
		enc := head.encodeHead(dst[pos:])
		pos += len(enc)
	}
	// ä¸‹é¢è¿™å¥å¾ˆå…³é”®ï¼Œå¦‚æœæˆ‘ä»¬ç¼–ç çš„æ•°æ®å®Œå…¨æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä¸Šé¢çš„forå¾ªç¯æ ¹æœ¬ä¸ä¼šæ‰§è¡Œï¼Œé‚£ä¹ˆä¸‹é¢è¿™æ®µä»£ç å°±å¯ä»¥å°†ç¼–ç çš„
	// å­—ç¬¦ä¸²æ•°æ®æ‹·è´å‡ºæ¥ï¼›è€Œå¦‚æœæˆ‘ä»¬ç¼–ç çš„æ•°æ®æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œé‚£ä¹ˆä¸‹é¢è¿™è¡Œä»£ç å¯ä»¥å°†æœ€åä¸€ä¸ªå¤´åé¢è·Ÿç€çš„ç¼–ç æ•°æ®æ‹·è´å‡ºæ¥
	copy(dst[pos:], buf.str[strPos:])
}

// writeTo â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeTo æ–¹æ³•æ¥å—ä¸€ä¸ª io.Writer å‚æ•°ï¼Œè¯¥æ–¹æ³•å°†ç¼–ç ç»“æœå®Œæ•´åœ°å†™å…¥åˆ°ç»™å®šçš„ io.Writer é‡Œï¼Œå®˜æ–¹çš„å®ç°ä»£ç è¯·è·³è½¬åˆ°ï¼š
//
//	https://github.com/ethereum/go-ethereum/blob/972007a517c49ee9e2a359950d81c74467492ed2/rlp/encbuffer.go#L79
//
// æˆ‘å¯¹å®˜æ–¹çš„å®ç°è¿›è¡Œäº†ç®€åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬å‰é¢çš„ makeBytes æ–¹æ³•å°±å¯ä»¥è·å¾—å®Œæ•´çš„ç¼–ç ç»“æœï¼Œä½•æ•…å†åˆ©ç”¨ä¸€ä¸ªæ–°çš„é€»è¾‘å»è·å–ç¼–ç ç»“æœå‘¢ï¼Ÿ
func (buf *encBuffer) writeTo(w io.Writer) error {
	bz := buf.makeBytes()
	if _, err := w.Write(bz); err != nil {
		return err
	}
	return nil
}

// Write â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// Write æ–¹æ³•å®ç°äº† io.Writer æ¥å£ï¼Œè¯¥æ–¹æ³•ç›´æ¥å°†ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡è¿½åŠ åˆ° encBuffer.str åé¢ã€‚è¿”å›å€¼æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªè¿”å›å€¼è¡¨ç¤º
// ç»™å®šåˆ‡ç‰‡çš„é•¿åº¦ï¼Œç¬¬äºŒä¸ªè¿”å›å€¼æ°¸è¿œä¸ºnilã€‚
func (buf *encBuffer) Write(bz []byte) (int, error) {
	buf.str = append(buf.str, bz...)
	return len(bz), nil
}

// writeBool â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeBool è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªboolç±»å‹çš„å˜é‡ï¼Œç„¶åæ ¹æ®å…¶å€¼å°†å…¶ç¼–ç åˆ° encBuffer.str é‡Œï¼Œå¦‚æœç»™çš„å€¼ç­‰äºtrueï¼Œé‚£ä¹ˆå°±å¾€stré‡Œå†™
// å…¥0x01ï¼Œå¦åˆ™å†™å…¥0x80ï¼Œ0x80è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªç©ºå€¼ã€‚
func (buf *encBuffer) writeBool(b bool) {
	if b {
		buf.str = append(buf.str, 0x01)
	} else {
		buf.str = append(buf.str, 0x80)
	}
}

// writeUint64 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeUint64 æ–¹æ³•æ¥å—ä¸€ä¸ª64ä½çš„æ— ç¬¦å·æ•´æ•°ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œç„¶åå°†å…¶ç¼–ç åˆ° encBuffer.str é‡Œï¼Œå¦‚æœè¾“å…¥çš„æ•´æ•°å¤§å°å°äº128ï¼Œåˆ™å¯
// ä»¥å°†å…¶çœ‹æˆæ˜¯ä¸€ä¸ªå•ç‹¬çš„ASCIIç ï¼Œé‚£ä¹ˆè¯¥æ•´æ•°è‡ªèº«å°±å¯ä»¥ä½œä¸ºç¼–ç ç»“æœå†™å…¥åˆ°stré‡Œï¼›å¦‚æœç»™å®šçš„æ•´æ•°å¤§äºæˆ–ç­‰äº128ï¼Œåˆ™ä¼šè®¡ç®—éœ€è¦å¤šå°‘ä¸ª
// å­—èŠ‚æ‰èƒ½å­˜å‚¨è¿™ä¸ªæ•°ï¼Œä¾‹å¦‚éœ€è¦nä¸ªï¼Œé‚£ä¹ˆç¼–ç ç»“æœå°±æ˜¯ï¼ˆ0x80+n||æ•´æ•°çš„å­—èŠ‚è¡¨ç°å½¢å¼ï¼‰ï¼›å¦‚æœç»™å®šçš„æ•´æ•°ç­‰äº0ï¼Œåˆ™å°†0x80å†™å…¥åˆ°stré‡Œï¼Œ
// ä»£è¡¨ç©ºå€¼ï¼Œä¸‹é¢ç»™å‡ºä¸‰ä¸ªç¤ºä¾‹æ¥å¯¹è¯¥æ–¹æ³•çš„é€»è¾‘è¿›è¡Œè§£é‡Šï¼š
//   - 0ï¼šappend(str, 0x80)
//   - 123ï¼šappend(str, byte(123))
//   - 1024ï¼šappend(str, []byte{0x80+2, 000000100, 00000000})
func (buf *encBuffer) writeUint64(i uint64) {
	if i == 0 {
		buf.str = append(buf.str, 0x80)
	} else if i < 128 {
		buf.str = append(buf.str, byte(i))
	} else {
		n := putInt(buf.auxiliaryBuf[1:], i)
		buf.auxiliaryBuf[0] = 0x80 + byte(n)
		buf.str = append(buf.str, buf.auxiliaryBuf[:1+n]...)
	}
}

// writeBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeBytes æ–¹æ³•æ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡bzï¼Œè¯¥æ–¹æ³•çš„ç›®çš„å°±æ˜¯å°†å­—èŠ‚åˆ‡ç‰‡bzç¼–ç åˆ° encBuffer.str é‡Œã€‚å½“bzæ»¡è¶³ä¸åŒæƒ…å†µæ—¶ï¼Œç¼–ç æ–¹å¼ä¹Ÿä¸
// åŒï¼Œå…·ä½“ä¼šé‡åˆ°ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š
//   - ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡bzé•¿åº¦ç­‰äº1ï¼Œå¹¶ä¸”é‡Œé¢å”¯ä¸€çš„å­—èŠ‚å°äºæˆ–ç­‰äº0x7Fï¼Œå³127ï¼Œé‚£ä¹ˆè¯¥å­—èŠ‚åˆ‡ç‰‡ï¼ˆæˆ–è€…è¯´è¯¥å­—èŠ‚æ›´å‡†ç¡®ï¼‰ä¼šè¢«ç›´æ¥è¿½åŠ åˆ°strå
//   - ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡é•¿åº¦å¤§äº1ï¼Œé‚£ä¹ˆä¼šå°†bzçš„é•¿åº¦å…ˆç¼–ç åˆ°stré‡Œï¼Œè¿™é‡Œåˆä¼šé‡åˆ°ä¸¤ç§æƒ…å†µï¼š1.é•¿åº¦å°äº56ï¼›2.é•¿åº¦å¤§äº55ã€‚é¢å¯¹ä¸åŒçš„æƒ…å†µï¼Œ
//     å¦‚ä½•å¯¹å­—èŠ‚é•¿åº¦è¿›è¡Œç¼–ç å¿…é¡»éµå®ˆä»¥ä¸‹å‡†åˆ™ï¼š
//     Â· å½“é•¿åº¦sizeå°äº56ï¼Œåˆ™å°†0x80+sizeçš„å€¼è¿½åŠ åˆ°strå
//     Â· å½“é•¿åº¦sizeå¤§äº55ï¼Œä¾‹å¦‚1024ï¼Œå­˜å‚¨1024æœ€å°‘éœ€è¦2ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«æ˜¯00000100å’Œ00000000ï¼Œé‚£ä¹ˆå°±å°†0xB7+2å’Œè¿™
//     ä¸¤ä¸ªå­—èŠ‚è¿½åŠ åˆ°strå
//     å­—èŠ‚çš„é•¿åº¦è¢«ç¼–ç åˆ°stré‡Œåï¼Œå‰©ä¸‹çš„å·¥ä½œåˆ™æ˜¯ç›´æ¥å°†åˆ‡ç‰‡bzè¿½åŠ åˆ°stråã€‚
func (buf *encBuffer) writeBytes(bz []byte) {
	if len(bz) == 1 && bz[0] < 0x80 {
		buf.str = append(buf.str, bz[0])
	} else {
		// å…ˆæŠŠå­—èŠ‚åˆ‡ç‰‡çš„é•¿åº¦ç¼–ç äº†
		buf.encodeStringHeader(len(bz))
		// å‰©ä¸‹çš„å°±æ˜¯ç›´æ¥å°†å­—èŠ‚åˆ‡ç‰‡è¿½åŠ åˆ°stråé¢
		buf.str = append(buf.str, bz...)
	}
}

// writeString â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeString æ–¹æ³•æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°sï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†sç¼–ç åˆ° encBuffer.str é‡Œï¼Œå®é™…ä¸Šï¼Œè¯¥æ–¹æ³•çš„é€»è¾‘æ˜¯è°ƒç”¨äº†å¦‚ä¸‹å‡½æ•°ï¼Œæ¥å®ç°
// å°†sç¼–ç åˆ°stré‡Œï¼š
//
//	buf.writeBytes([]byte(s))
func (buf *encBuffer) writeString(s string) {
	buf.writeBytes([]byte(s))
}

// writeBigInt â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// writeBigInt æ–¹æ³•æ¥å—ä¸€ä¸ªå¤§æ•´æ•°iï¼Œiçš„ç±»å‹æ˜¯*big.Intï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†å¤§æ•´æ•°ç¼–ç åˆ° encBuffer.str é‡Œã€‚äº‹å®ä¸Šï¼Œå¤§æ•´æ•°ä¸ä¸€å®šå°±æ¯”
// æœ€å¤§çš„64ä½æ— ç¬¦å·æ•´æ•°å¤§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ writeUint64 æ–¹æ³•å°†è¯¥æ‰€è°“çš„å¤§æ•´æ•°ç¼–ç åˆ°stré‡Œï¼›ä½†æ˜¯ï¼Œå¦‚æœç»™å®šçš„å¤§æ•´æ•°å¤§äºæœ€å¤§çš„64
// ä½æ— ç¬¦å·æ•´æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶çœ‹æˆæ˜¯ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡è¿›è¡Œç¼–ç ï¼Œæ­¤æ—¶è¯¥å¤§æ•´æ•°éœ€è¦è¶…è¿‡8ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹å®˜æ–¹çš„æºç ä½œä¸ºä¸€äº›æ”¹
// åŠ¨ï¼Œç»è¿‡æµ‹è¯•ï¼Œæ”¹åŠ¨åçš„æ•ˆæœå’Œå®˜æ–¹æºç ä¸€æ ·ã€‚
func (buf *encBuffer) writeBigInt(i *big.Int) {
	if i.BitLen() <= 64 {
		buf.writeUint64(i.Uint64())
		return
	}
	// è®¡ç®—è¯¥å¤§æ•´æ•°éœ€è¦å¤šå°‘ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼Œè¿™é‡Œå®˜æ–¹çš„è®¡ç®—æ–¹å¼æ˜¯ï¼š
	// n := ((i.BitLen() + 7) & -8) >> 3
	// ä¸æ‡‚ä¸ºä½•è¦è¿™æ ·å†™ï¼Œæ˜¾å¾—æ›´é«˜çº§ï¼Ÿ
	n := (i.BitLen() + 7) / 8
	buf.encodeStringHeader(n)
	enc, index := make([]byte, n), n
	for _, word := range i.Bits() {
		for j := 0; j < math.WordBytes && index > 0; j++ {
			index--
			enc[index] = byte(word)
			word >>= 8
		}
	}
	buf.str = append(buf.str, enc...)
}

// encodeStringHeader â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/4|
//
// encodeStringHeader æ–¹æ³•æ¥å—ä¸€ä¸ªæ•´å‹sizeä½œä¸ºè¾“å…¥ï¼Œé¡¾åæ€ä¹‰ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯åœ¨ç¼–ç å­—ç¬¦ä¸²æ•°æ®æ—¶ï¼Œå°†å­—ç¬¦ä¸²çš„é•¿åº¦ç¼–ç åˆ° encBuffer.str
// é‡Œï¼Œè¯¥æ–¹æ³•ä»…åœ¨ç¼–ç é•¿åº¦å¤§äº1çš„å­—ç¬¦ä¸²æˆ–è€…å­—èŠ‚åˆ‡ç‰‡æ—¶æ‰ä¼šè¢«ä½¿ç”¨ã€‚ç¼–ç æ—¶ï¼Œéœ€è¦éµå®ˆä»¥ä¸‹ä¸¤æ¡è§„åˆ™ï¼š
//
//	Â· å½“é•¿åº¦sizeå°äº56ï¼Œåˆ™å°†0x80+sizeçš„å€¼è¿½åŠ åˆ°strå
//	Â· å½“é•¿åº¦sizeå¤§äº55ï¼Œä¾‹å¦‚1024ï¼Œå­˜å‚¨1024æœ€å°‘éœ€è¦2ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«æ˜¯00000100å’Œ00000000ï¼Œé‚£ä¹ˆå°±å°†0xB7+2å’Œè¿™
//	  ä¸¤ä¸ªå­—èŠ‚è¿½åŠ åˆ°strå
func (buf *encBuffer) encodeStringHeader(size int) {
	if size < 56 {
		buf.str = append(buf.str, 0x80+byte(size))
	} else {
		n := putInt(buf.auxiliaryBuf[1:], uint64(size))
		buf.auxiliaryBuf[0] = 0xB7 + byte(n)
		buf.str = append(buf.str, buf.auxiliaryBuf[:1+n]...)
	}
}

// listStart â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// listStart æ–¹æ³•ç”¨æ¥å¾€ encBuffer.lHeads é‡Œæ·»åŠ ä¸€ä¸ª listHead å®ä¾‹ï¼Œè¯¥æ–¹æ³•åœ¨ç¼–ç åˆ—è¡¨æ•°æ®å‰è¢«è°ƒç”¨ï¼Œç”¨æ¥ä¸ºç¼–ç åˆ—è¡¨æ•°æ®ä½œå‡†
// å¤‡ï¼Œä»è¯¥æ–¹æ³•çš„é€»è¾‘ä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒlistHead.offset çš„ä½œç”¨å°±æ˜¯æ ‡è®°ç¼–ç ç»“æœåœ¨ encBuffer.str çš„ä»€ä¹ˆä½å€¼å¤„å¼€å§‹è¢«è¿½åŠ ï¼Œè¯¥æ–¹æ³•è¿”
// å›çš„å‚æ•°è¡¨ç¤º *encBuffer é‡Œé¢åˆšåˆšæ·»åŠ çš„åˆ—è¡¨å¤´çš„ç´¢å¼•ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœç»™è¯¥ç´¢å¼•å€¼åŠ 1ï¼Œå¾—åˆ°çš„å€¼è¡¨ç¤ºçš„å°†æ˜¯ *encBuffer é‡Œé¢åˆ—
// è¡¨çš„æ•°é‡ã€‚
func (buf *encBuffer) listStart() int {
	head := listHead{offset: len(buf.str), size: buf.lHeadsSize}
	buf.lHeads = append(buf.lHeads, head)
	return len(buf.lHeads) - 1
}

// listEnd â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// listEnd æ–¹æ³•æ¥å—ä¸€ä¸ªæ•´å‹å‚æ•°indexï¼Œè¯¥æ–¹æ³•åœ¨ç¼–ç åˆ—è¡¨æ•°æ®ç»“æŸä¹‹åè¢«è°ƒç”¨ï¼Œå…¶ç›®çš„å°±æ˜¯æ›´æ–° encBuffer.lHeads ä¸Šç»™å®šindexç´¢å¼•
// ä½å€¼å¤„çš„ listHead.size å’Œ encBuffer.lHeadsSize ä¸¤ä¸ªå­—æ®µã€‚
// ç»“åˆ listStart æ–¹æ³•ï¼Œæˆ‘ä»¬å¯¹ä¸€ä¸ªç»“æ„ä½“å®ä¾‹è¿›è¡Œç¼–ç ï¼Œæ¥çœ‹çœ‹ listStart å’Œ listEnd ç©¶ç«Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œç»™å‡ºä¸¤ä¸ªç»“æ„ä½“ï¼š
//
//	type Store struct {
//		Location string
//	}
//
//	type Dog struct {
//		Name  string
//		Age   uint64
//		Store Store
//	}
//
// å®ä¾‹åŒ–ä¸€ä¸ªDogå®ä¾‹ï¼šd := Dog{Name: "aaa", Age: 12, Store: Store{Location: "Hefei"}}ï¼Œç„¶åå¯¹å…¶è¿›è¡Œç¼–ç ï¼Œè¿™é‡Œæˆ‘ä»¬å¯
// ä»¥çœ‹åˆ°æˆ‘ä»¬ç»™å‡ºçš„ç»“æ„ä½“å®ä¾‹æ˜¯ç»“æ„ä½“ä¸­å¥—ç»“æ„ä½“ï¼Œé‚£ä¹ˆå¯¹äºrlpç¼–ç æ¥è¯´å°±æ˜¯ï¼Œåˆ—è¡¨ä¸­å¥—åˆ—è¡¨ï¼Œå› æ­¤è¿™é‡Œæˆ–äº§ç”Ÿä¸¤ä¸ªè¡¨å¤´ï¼Œæˆ‘ä»¬å…ˆç»™å‡ºç¼–ç ç»“æœï¼š
//
//	[204 131 97 97 97 12 198 133 72 101 102 101 105]
//
// å¯ä»¥çœ‹åˆ°ï¼Œç¼–ç ç»“æœä¸­çš„[198 133 72 101 102 101 105]æ˜¯å¯¹Store: Store{Location: "Hefei"}åˆ—è¡¨æ•°æ®ç¼–ç äº§ç”Ÿçš„ç»“æœï¼Œå®ƒçš„è¡¨
// å¤´å‰ç¼€æ˜¯[198]ï¼Œç„¶å[204 131 97 97 97 12 198 133 72 101 102 101 105]æ˜¯å¯¹æ•´ä¸ªDogå®ä¾‹ï¼ˆå¤–é¢çš„åˆ—è¡¨ï¼‰ç¼–ç çš„ç»“æœï¼Œå®ƒçš„è¡¨å¤´
// å‰ç¼€æ˜¯[204]ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰è¡¨å¤´çš„å‰ç¼€å»æ‰ï¼Œå°†å¾—åˆ° encBuffer.strï¼š[131 97 97 97 12 133 72 101 102 101 105]ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªè¡¨å¤´
// çš„offsetåº”å½“ç­‰äº0ï¼Œsizeåˆ™ç­‰äº12ï¼Œä¹‹æ‰€ä»¥ç­‰äº12ï¼Œæ˜¯å› ä¸ºå†…éƒ¨åˆ—è¡¨ç¼–ç çš„ç»“æœï¼ˆåŒ…æ‹¬è¡¨å¤´å‰ç¼€ä¹Ÿè¢«ç®—åœ¨å†…ï¼‰é•¿åº¦ç­‰äº7ï¼ŒåŠ ä¸Š5å°±ç­‰äº12ï¼Œè¡¨ç¤º
// çš„æ˜¯[131 97 97 97 12 198 133 72 101 102 101 105]çš„é•¿åº¦ï¼Œç¬¬äºŒä¸ªè¡¨å¤´çš„offsetåº”å½“ç­‰äº5ï¼Œsizeåˆ™ç­‰äº6ï¼Œ6è¡¨ç¤º
// [133 72 101 102 101 105]çš„é•¿åº¦ã€‚ç”±äºä¸¤ä¸ªè¡¨å¤´å‰ç¼€çš„é•¿åº¦éƒ½ç­‰äº1ï¼Œæ‰€ä»¥ encBuffer.lHeadsSize æœ€ç»ˆç­‰äº2ã€‚
func (buf *encBuffer) listEnd(index int) {
	head := &buf.lHeads[index]
	// æ­¤æ—¶çš„buf.size()=xåŸ+håŸ+xæ–°ï¼Œhead.offset=xåŸï¼Œhead.size=håŸï¼Œä¹‹æ‰€ä»¥æ­¤æ—¶çš„buf.size()ä¸èƒ½åŠ ä¸Šhæ–°ï¼Œæ˜¯å› ä¸ºhæ–°è¿˜æ²¡
	// æœ‰è¢«è®¡ç®—å‡ºæ¥å‘¢
	// é‚£ä¹ˆä¸‹é¢çš„å…¬å¼å¯ä»¥æ›¿æ¢ä¸ºï¼šxåŸ+håŸ+xæ–°-xåŸ-håŸ=xæ–°
	head.size = buf.size() - head.offset - head.size
	if head.size < 56 {
		buf.lHeadsSize++
	} else {
		buf.lHeadsSize += 1 + intSize(uint64(head.size))
	}
}

// encode â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// encode æ¥å—ä¸€ä¸ªå‚æ•°interface{}ï¼Œç„¶åæ ¹æ®è¯¥å‚æ•°çš„ç±»å‹é€‰æ‹©å¯¹åº”çš„ç¼–ç å™¨ï¼Œåˆ©ç”¨é€‰ä¸­çš„ç¼–ç å™¨ç¼–ç ç»™å®šçš„å‚æ•°æ•°æ®ã€‚
func (buf *encBuffer) encode(val interface{}) error {
	rVal := reflect.ValueOf(val)
	encoder, err := cachedWriter(rVal.Type())
	if err != nil {
		return err
	}
	return encoder(rVal, buf)
}

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// encReader â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// encReader ç»“æ„ä½“å°† *encBuffer å®ä¾‹åŒ…è£…èµ·æ¥ï¼Œè¯¥ç»“æ„ä½“å®ç°äº† Read æ–¹æ³•ï¼Œå¯ä»¥å°† *encBuffer ç¼“å­˜çš„ç¼–ç æ•°æ®è¯»å–åˆ°
// ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡é‡Œã€‚
type encReader struct {
	buf    *encBuffer // æˆ‘ä»¬ä» buf ç¼“å†²é‡Œè¯»å–æ•°æ®
	lhpos  int        // æˆ‘ä»¬æ­£åœ¨è¯»å–çš„åˆ—è¡¨æ•°æ®çš„åˆ—è¡¨å¤´çš„ç´¢å¼•ä½å€¼
	strpos int        // æ­£åœ¨è¯»å– encBuffer.str çš„ä½å€¼
	piece  []byte     // ä¸‹ä¸€ä¸ªè¦è¢«è¯»å–çš„æ•°æ®ç‰‡æ®µ
}

// Read â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// Read æ–¹æ³•æ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ç¼“å†²åŒºç”¨äºå­˜å‚¨è¯»å–çš„æ•°æ®ï¼Œè¯¥æ–¹æ³•åœ¨å¾ªç¯ä¸­ä¸åœåœ°è°ƒç”¨ next æ–¹æ³•è·å–æ¥ä¸‹æ¥è¦è¢«è¯»å–çš„æ•°æ®ï¼Œè¿™æ ·
// å¯ä»¥åœ¨ç»™å®šçš„ç¼“å†²åŒºè¿‡å°çš„æƒ…å†µä¸‹ï¼Œè®°ä¸‹è¯»å–åˆ°äº†å“ªé‡Œï¼Œåœ¨ä»¥åç»§ç»­è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œä»ä¹‹å‰åœä¸‹çš„ä½å€¼å¤„ç»§ç»­è¯»å–ï¼Œå¦‚æœ encBuffer
// é‡Œé¢çš„æ•°æ®è¯»å–å®Œï¼Œä¼šè¿”å› io.EOFï¼Œç„¶å encReader.encBuffer ä¼šè¢«é‡æ–°æ”¾åˆ° encBufferPoolæ± å­é‡Œã€‚
func (r *encReader) Read(bz []byte) (n int, err error) {
	for {
		if r.piece = r.next(); r.piece == nil {
			if r.buf != nil {
				encBufferPool.Put(r.buf)
				r.buf = nil
			}
			return n, io.EOF
		}
		m := copy(bz[n:], r.piece)
		n += m
		if m < len(r.piece) {
			// r.piece é‡Œé¢çš„æ•°æ®æ²¡æœ‰è¢«è¯»å–å®Œï¼Œé‚£ä¹ˆå°±åªå¥½ç­‰å¾…ä¸‹æ¬¡è¢«è¯»å–å’¯ï¼
			r.piece = r.piece[m:]
			return n, nil
		}
		r.piece = nil
	}
}

// next â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// next æ–¹æ³•è¿”å› encBuffer é‡Œé¢æ¥ä¸‹æ¥è¦è¢«è¯»å–çš„æ•°æ®ï¼Œå¦‚æœ Read æ–¹æ³•ç»™å®šçš„bzè¶³å¤Ÿå¤§ï¼Œå¹¶ä¸”å‡è®¾ç¼“å†²åŒºç­‰å¾…è¢«è¯»å–çš„æ•°æ®ä¸ºï¼š
//
//	[204 131 97 97 97 12 198 133 72 101 102 101 105]
//
// é‚£ä¹ˆè¯¥æ–¹æ³•åœ¨forå¾ªç¯é‡Œæ¯æ¬¡è¿”å›çš„æ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼š
//  1. ç¬¬ä¸€æ¬¡å¾ªç¯ï¼šè¿”å›ç¬¬ä¸€ä¸ªåˆ—è¡¨å¤´çš„ç¼–ç æ•°æ®[204]
//  2. ç¬¬äºŒæ¬¡å¾ªç¯ï¼šè¿”å›ç¬¬ä¸€ä¸ªåˆ—è¡¨å¤´åˆ°ç¬¬äºŒä¸ªåˆ—è¡¨å¤´ä¹‹é—´çš„æ•°æ®[131 97 97 97 12]
//  3. ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼šè¿”å›ç¬¬äºŒä¸ªåˆ—è¡¨å¤´çš„ç¼–ç æ•°æ®[198]
//  4. ç¬¬å››æ¬¡å¾ªç¯ï¼šç”±äºç¬¬äºŒä¸ªåˆ—è¡¨å¤´å°±æ˜¯æœ€åä¸€ä¸ªåˆ—è¡¨å¤´ï¼Œå› æ­¤ç›´æ¥è¿”å›strç¼“å†²åŒºå‰©ä¸‹çš„æ‰€æœ‰æ•°æ®[133 72 101 102 101 105]
//  5. ç¬¬5æ¬¡å¾ªç¯ï¼šç”±äºåœ¨ç¬¬4æ¬¡å¾ªç¯é‡Œï¼Œæ‰€æœ‰æ•°æ®éƒ½è¢«è¯»å–å®Œï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡è¿”å›å€¼ä¸ºnil
func (r *encReader) next() []byte {
	switch {
	case r.buf == nil:
		return nil
	case r.piece != nil:
		// å½“å‰ä»ç„¶æœ‰å¯è¢«è¯»å–çš„æ•°æ®ï¼Œè¿™ç§æƒ…å†µåœ¨ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡ç¼“å†²åŒºä¸å¤Ÿå¤§çš„æƒ…å†µä¸‹ä¼šå‡ºç°
		return r.piece
	case r.lhpos < len(r.buf.lHeads):
		// ç›®å‰è¿˜æ²¡è¯»å–åˆ°æœ€åä¸€ä¸ªåˆ—è¡¨å¤´ï¼Œè·å–å½“å‰æ­£åœ¨è¯»å–çš„åˆ—è¡¨æ•°æ®çš„å¤´
		head := r.buf.lHeads[r.lhpos]
		// è®¡ç®—åœ¨å½“å‰åˆ—è¡¨å¤´ä¹‹å‰è¿˜æœ‰å¤šå°‘æ•°æ®æœªè¢«è¯»å–ï¼Œè¯¥é€»è¾‘è®¾è®¡çš„å¾ˆå·§å¦™ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ï¼Œç¬¬ä¸€ä¸ªåˆ—è¡¨å¤´çš„offsetä¸€èˆ¬ç­‰äº0ï¼Œæ‰€ä»¥ï¼Œ
		// ç¬¬ä¸€æ¬¡è¿”å›çš„è¦è¢«è¯»å–çš„æ•°æ®å°±æ˜¯åˆ—è¡¨å¤´çš„ç¼–ç æ•°æ®ï¼Œè€Œä¸æ˜¯strç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œå› æ­¤strposè¿˜ä¼šç­‰äº0ï¼Œæ¥ä¸‹æ¥ï¼Œç¬¬äºŒä¸ªåˆ—è¡¨
		// å¤´çš„offsetä¸€å®šå¤§äº0ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±çŸ¥é“åœ¨ç¬¬äºŒä¸ªåˆ—è¡¨å¤´å‰ï¼Œstrç¼“å†²åŒºé‡Œæœ‰ä¸€éƒ¨åˆ†æ•°æ®æœªè¢«è¯»å–ï¼Œè€Œè¯¥æ®µæ•°æ®æ­£æ˜¯ç¬¬ä¸€ä¸ªåˆ—è¡¨å¤´
		// åé¢è·Ÿç€çš„æ•°æ®
		sizeBefore := head.offset - r.strpos
		if sizeBefore > 0 {
			// å¦‚æœåœ¨å½“å‰åˆ—è¡¨å¤´å‰è¿˜æœ‰æ•°æ®æœªè¢«è¯»å–
			p := r.buf.str[r.strpos:head.offset] // è·å–è¿™æ®µæœªè¢«è¯»å–çš„æ•°æ®
			r.strpos += sizeBefore
			// å°†è¿™æ®µæœªè¢«è¯»å–æ•°æ®è¿”å›å‡ºå»ä½œä¸ºä¸‹ä¸€ä¸ªå³å°†è¢«è¯»å–çš„æ•°æ®
			return p
		}
		// å½“å‰åˆ—è¡¨å¤´ä¹‹å‰çš„æ‰€æœ‰æ•°æ®éƒ½è¢«è¯»å–å®Œæ¯•ï¼Œå°†åˆ—è¡¨å¤´çš„ç´¢å¼•å€¼åŠ 1
		r.lhpos++
		// å°†åˆ—è¡¨å¤´çš„å‰ç¼€è¿”å›å‡ºå»ï¼Œä½œä¸ºä¸‹ä¸€ä¸ªå³å°†è¢«è¯»å–çš„æ•°æ®
		return head.encodeHead(r.buf.auxiliaryBuf[:])
	case r.strpos < len(r.buf.str):
		// å­—ç¬¦ä¸²ç¼“å†²åŒºçš„æ•°æ®è¿˜æ²¡è¯»å–å®Œï¼Œä½†æ˜¯ç›®å‰å·²ç»è¯»å–åˆ°æœ€åä¸€ä¸ªåˆ—è¡¨å¤´äº†ï¼Œé‚£ä¹ˆç´¢æ€§å°†å­—ç¬¦ä¸²ç¼“å†²åŒºé‡Œå‰©ä¸‹çš„æ•°æ®å…¨éƒ¨è¿”å›å‡ºå»
		p := r.buf.str[r.strpos:]
		r.strpos = len(r.buf.str)
		return p
	default:
		return nil
	}
}

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// EncodeBuffer â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// EncodeBuffer
type EncodeBuffer struct {
	buf       *encBuffer
	dst       io.Writer
	ownBuffer bool
}

// NewEncodeBuffer â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// NewEncodeBuffer æ–¹æ³•æ ¹æ®ç»™å®šçš„ io.Writer ç”Ÿæˆä¸€ä¸ªæ–°çš„ EncodeBufferã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœç»™å®šçš„ io.Writer
// æ»¡è¶³ä¸åŒçš„æ¡ä»¶ï¼Œç”Ÿæˆçš„ EncodeBuffer ä¼šæœ‰åŒºåˆ«ï¼š
//   - å¦‚æœç»™å®šçš„ io.Writer çš„åº•å±‚å®ç°æ˜¯ EncodeBufferæˆ–è€…æ˜¯*EncodeBufferï¼Œå†æˆ–è€…æ˜¯*encBufferï¼Œåˆ™ç”Ÿæˆçš„
//     EncodeBuffer å®ä¾‹å¦‚ä¸‹ï¼š
//     EncodeBuffer{buf: encBufferFromWriter(dst), dst: nil, ownBuffer: false}
//     å…¶ä¸­dstå°±æ˜¯ NewEncodeBuffer æ–¹æ³•çš„å…¥å‚
//   - å¦‚æœç»™å®šçš„ io.Writer å°±æ˜¯æ™®é€šçš„writerï¼Œåˆ™ç”Ÿæˆçš„ EncodeBuffer å®ä¾‹å¦‚ä¸‹ï¼š
//     EncodeBuffer{buf: encBufferPool.Get().(*encBuffer), dst: dst, ownBuffer: true}
func NewEncodeBuffer(dst io.Writer) EncodeBuffer {
	var encBuf EncodeBuffer
	encBuf.Reset(dst)
	return encBuf
}

// Reset â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// Reset æ–¹æ³•æ¥å—ä¸€ä¸ªå®ç°äº† io.Writer æ¥å£çš„å¯¹è±¡å®ä¾‹dstï¼Œå¦‚æœå½“å‰ EncodeBuffer.buf æ˜¯é€šè¿‡ encBufferFromWriter
// æ–¹æ³•è·å¾—çš„ï¼Œé‚£ä¹ˆè°ƒç”¨ Reset æ–¹æ³•ä¼španicï¼Œå¦‚æœç»™å®šçš„dstå‚æ•°ä¸ä¸ºç©ºï¼Œä¸”dstçš„åº•å±‚å®ç°æ˜¯ EncodeBuffer æˆ– *EncodeBuffer
// æˆ– *encBufferï¼Œåˆ™é‡ç½® EncodeBuffer.buf ä¸ºdstï¼Œå¹¶ä¸” EncodeBuffer.ownBuffer ç½®ä¸ºfalseï¼Œåˆ°æ­¤ï¼Œç›´æ¥é€€å‡º Resetæ–¹
// æ³•ï¼›å¦åˆ™å°±ä» encBufferPool é‡Œé¢é‡æ–°è·å–ä¸€ä¸ª *encBuffer å®ä¾‹ï¼Œå¹¶èµ‹å€¼ç»™ EncodeBuffer.bufï¼Œç„¶åå°†
// EncodeBuffer.ownBuffer ç½®ä¸ºtrueï¼Œæœ€åè°ƒç”¨ encBuffer.reset æ–¹æ³•é‡ç½® EncodeBuffer.bufã€‚
func (encBuf *EncodeBuffer) Reset(dst io.Writer) {
	if encBuf.buf != nil && encBuf.ownBuffer == false {
		// æ— æ³•é‡ç½®è¡ç”Ÿçš„EncodeBufferï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
		// æ‰€è°“è¡ç”Ÿçš„ EncodeBufferï¼Œå…¶å®å°±æ˜¯ EncodeBuffer.buf æ˜¯ä»å…¶ä»–åœ°æ–¹è¡ç”Ÿè¿‡æ¥çš„ï¼Œ
		// å¦‚æœé‡ç½®çš„è¯ï¼Œä¼šå¯¹å…¶ä»–åœ°æ–¹çš„ä»£ç äº§ç”Ÿå½±å“ã€‚
		panic("can't Reset derived EncodeBuffer")
	}
	if dst != nil {
		if w := encBufferFromWriter(dst); w != nil {
			*encBuf = EncodeBuffer{buf: w, dst: nil, ownBuffer: false}
			return
		}
	}
	if encBuf.buf == nil {
		encBuf.buf = encBufferPool.Get().(*encBuffer)
		encBuf.ownBuffer = true
	}
	encBuf.buf.reset()
	encBuf.dst = dst
}

// Write â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// Write æ–¹æ³•æ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡å‚æ•°bzï¼Œè¯¥æ–¹æ³•å®é™…ä¸Šè°ƒç”¨ encBuffer.Write æ–¹æ³•å®ç°å°†bzè¿½åŠ åˆ° encBuffer.str åé¢ã€‚
func (encBuf EncodeBuffer) Write(bz []byte) (int, error) {
	return encBuf.buf.Write(bz)
}

// Flush â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// Flush æ–¹æ³•å°† EncodeBuffer.buf é‡Œé¢ç¼“å­˜çš„rlpç¼–ç æ•°æ®å…¨éƒ¨å†™å…¥åˆ° EncodeBuffer.dst ä¸­ï¼Œå†™å®Œä¹‹åï¼ŒEncodeBuffer.buf
// å¦‚æœæ˜¯ EncodeBuffer ä» encBufferPool é‡Œé¢æ‹¿çš„ï¼Œé‚£å°±è¦å†æŠŠå®ƒæ”¾å›å»ï¼Œå¹¶ä¸” EncodeBuffer ä¼šè¢«é‡ç½®ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ
// Flush æ–¹æ³•åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹æ¬¡è¿˜æƒ³è°ƒç”¨ï¼Œå°±å¿…é¡»åœ¨è°ƒç”¨å‰å…ˆæ‰§è¡Œ Reset æ–¹æ³•ã€‚
func (encBuf *EncodeBuffer) Flush() error {
	var err error
	if encBuf.dst != nil {
		err = encBuf.buf.writeTo(encBuf.dst)
	}
	if encBuf.ownBuffer {
		// å¦‚æœå½“å‰*encBufferæ˜¯ä»encBufferPoolé‡Œé¢è·å–çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨æŠŠ*encBufferé‡Œé¢ç¼“å­˜çš„æ•°æ®åˆ·æ–°åˆ° io.Writer
		// é‡Œé¢ä¹‹åï¼Œå°±å¯ä»¥å°†*encBufferç»™é‡Šæ”¾äº†
		encBufferPool.Put(encBuf.buf)
	}
	*encBuf = EncodeBuffer{}
	return err
}

// ToBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// ToBytes æ–¹æ³•è°ƒç”¨ EncodeBuffer.buf.makeBytes() æ–¹æ³•ï¼Œå°†ç¼–ç ç»“æœå®Œæ•´çš„è¿”å›å‡ºæ¥ã€‚
func (encBuf *EncodeBuffer) ToBytes() []byte {
	return encBuf.buf.makeBytes()
}

// AppendToBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// AppendToBytes æ–¹æ³•æ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡dstä½œä¸ºå…¥å‚ï¼Œè¯¥æ–¹æ³•å°±æ˜¯å°† EncodeBuffer.buf å†…å­˜å‚¨çš„rlpç¼–ç ç»“æœè¿½åŠ åˆ°dståé¢ã€‚
func (encBuf *EncodeBuffer) AppendToBytes(dst []byte) []byte {
	size := encBuf.buf.size()
	data := make([]byte, size)
	encBuf.buf.copyTo(data)
	return append(dst, data...)
}

// WriteBool â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// WriteBool æ–¹æ³•æ¥å—ä¸€ä¸ªboolç±»å‹çš„å˜é‡ï¼Œç„¶åæ ¹æ®å…¶å€¼å°†å…¶ç¼–ç åˆ° EncodeBuffer.buf.str é‡Œï¼Œå¦‚æœç»™çš„å€¼ç­‰äºtrueï¼Œé‚£ä¹ˆ
// å°±å¾€stré‡Œå†™å…¥0x01ï¼Œå¦åˆ™å†™å…¥0x80ï¼Œ0x80è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªç©ºå€¼ã€‚
func (encBuf EncodeBuffer) WriteBool(b bool) {
	encBuf.buf.writeBool(b)
}

// WriteUint64 â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// WriteUint64 æ–¹æ³•æ¥å—ä¸€ä¸ª64ä½çš„æ— ç¬¦å·æ•´æ•°ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œç„¶åå°†å…¶ç¼–ç åˆ° EncodeBuffer.buf.str é‡Œï¼Œå¦‚æœè¾“å…¥çš„æ•´æ•°å¤§å°å°äº
// 128ï¼Œåˆ™å¯ä»¥å°†å…¶çœ‹æˆæ˜¯ä¸€ä¸ªå•ç‹¬çš„ASCIIç ï¼Œé‚£ä¹ˆè¯¥æ•´æ•°è‡ªèº«å°±å¯ä»¥ä½œä¸ºç¼–ç ç»“æœå†™å…¥åˆ°stré‡Œï¼›å¦‚æœç»™å®šçš„æ•´æ•°å¤§äºæˆ–ç­‰äº128ï¼Œåˆ™ä¼šè®¡ç®—
// éœ€è¦å¤šå°‘ä¸ªå­—èŠ‚æ‰èƒ½å­˜å‚¨è¿™ä¸ªæ•°ï¼Œä¾‹å¦‚éœ€è¦nä¸ªï¼Œé‚£ä¹ˆç¼–ç ç»“æœå°±æ˜¯ï¼ˆ0x80+n||æ•´æ•°çš„å­—èŠ‚è¡¨ç°å½¢å¼ï¼‰ï¼›å¦‚æœç»™å®šçš„æ•´æ•°ç­‰äº0ï¼Œåˆ™å°†0x80å†™
// å…¥åˆ°stré‡Œï¼Œä»£è¡¨ç©ºå€¼ï¼Œä¸‹é¢ç»™å‡ºä¸‰ä¸ªç¤ºä¾‹æ¥å¯¹è¯¥æ–¹æ³•çš„é€»è¾‘è¿›è¡Œè§£é‡Šï¼š
//   - 0ï¼šappend(str, 0x80)
//   - 123ï¼šappend(str, byte(123))
//   - 1024ï¼šappend(str, []byte{0x80+2, 000000100, 00000000})
func (encBuf EncodeBuffer) WriteUint64(i uint64) {
	encBuf.buf.writeUint64(i)
}

// WriteBigInt â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// WriteBigInt æ–¹æ³•æ¥å—ä¸€ä¸ªå¤§æ•´æ•°iï¼Œiçš„ç±»å‹æ˜¯*big.Intï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†å¤§æ•´æ•°ç¼–ç åˆ° EncodeBuffer.buf.str é‡Œã€‚äº‹å®ä¸Šï¼Œå¤§æ•´æ•°ä¸
// ä¸€å®šå°±æ¯”æœ€å¤§çš„64ä½æ— ç¬¦å·æ•´æ•°å¤§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ writeUint64 æ–¹æ³•å°†è¯¥æ‰€è°“çš„å¤§æ•´æ•°ç¼–ç åˆ°stré‡Œï¼›ä½†æ˜¯ï¼Œå¦‚æœç»™å®šçš„å¤§æ•´æ•°å¤§äº
// æœ€å¤§çš„64ä½æ— ç¬¦å·æ•´æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶çœ‹æˆæ˜¯ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡è¿›è¡Œç¼–ç ï¼Œæ­¤æ—¶è¯¥å¤§æ•´æ•°éœ€è¦è¶…è¿‡8ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚
func (encBuf EncodeBuffer) WriteBigInt(i *big.Int) {
	encBuf.buf.writeBigInt(i)
}

// WriteBytes â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// WriteBytes æ–¹æ³•æ¥å—ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡bzï¼Œè¯¥æ–¹æ³•çš„ç›®çš„å°±æ˜¯å°†å­—èŠ‚åˆ‡ç‰‡bzç¼–ç åˆ° EncodeBuffer.buf.str é‡Œã€‚å½“bzæ»¡è¶³ä¸åŒæƒ…å†µæ—¶ï¼Œç¼–ç 
// æ–¹å¼ä¹Ÿä¸åŒï¼Œå…·ä½“ä¼šé‡åˆ°ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š
//   - ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡bzé•¿åº¦ç­‰äº1ï¼Œå¹¶ä¸”é‡Œé¢å”¯ä¸€çš„å­—èŠ‚å°äºæˆ–ç­‰äº0x7Fï¼Œå³127ï¼Œé‚£ä¹ˆè¯¥å­—èŠ‚åˆ‡ç‰‡ï¼ˆæˆ–è€…è¯´è¯¥å­—èŠ‚æ›´å‡†ç¡®ï¼‰ä¼šè¢«ç›´æ¥è¿½åŠ åˆ°stråã€‚
//   - ç»™å®šçš„å­—èŠ‚åˆ‡ç‰‡é•¿åº¦å¤§äº1ï¼Œé‚£ä¹ˆä¼šå°†bzçš„é•¿åº¦å…ˆç¼–ç åˆ°stré‡Œï¼Œè¿™é‡Œåˆä¼šé‡åˆ°ä¸¤ç§æƒ…å†µï¼š1.é•¿åº¦å°äº56ï¼›2.é•¿åº¦å¤§äº55ã€‚é¢å¯¹ä¸åŒçš„æƒ…å†µï¼Œ
//     å¦‚ä½•å¯¹å­—èŠ‚é•¿åº¦è¿›è¡Œç¼–ç å¿…é¡»éµå®ˆä»¥ä¸‹å‡†åˆ™ï¼š
//     Â· å½“é•¿åº¦sizeå°äº56ï¼Œåˆ™å°†0x80+sizeçš„å€¼è¿½åŠ åˆ°strå
//     Â· å½“é•¿åº¦sizeå¤§äº55ï¼Œä¾‹å¦‚1024ï¼Œå­˜å‚¨1024æœ€å°‘éœ€è¦2ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«æ˜¯00000100å’Œ00000000ï¼Œé‚£ä¹ˆå°±å°†0xB7+2å’Œè¿™
//     ä¸¤ä¸ªå­—èŠ‚è¿½åŠ åˆ°stråï¼Œå­—èŠ‚çš„é•¿åº¦è¢«ç¼–ç åˆ°stré‡Œåï¼Œå‰©ä¸‹çš„å·¥ä½œåˆ™æ˜¯ç›´æ¥å°†åˆ‡ç‰‡bzè¿½åŠ åˆ°stråã€‚
func (encBuf EncodeBuffer) WriteBytes(bz []byte) {
	encBuf.buf.writeBytes(bz)
}

// WriteString â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// WriteString æ–¹æ³•æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°sï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†sç¼–ç åˆ° EncodeBuffer.buf.str é‡Œï¼Œå®é™…ä¸Šï¼Œè¯¥æ–¹æ³•çš„é€»è¾‘æ˜¯è°ƒç”¨äº†å¦‚ä¸‹
// å‡½æ•°ï¼Œæ¥å®ç°å°†sç¼–ç åˆ°stré‡Œï¼š
//
//	EncodeBuffer.buf.writeString(s)
func (encBuf EncodeBuffer) WriteString(s string) {
	encBuf.buf.writeString(s)
}

// ListStart â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// ListStart æ–¹æ³•ç”¨æ¥å¾€ EncodeBuffer.buf.lHeads é‡Œæ·»åŠ ä¸€ä¸ª listHead å®ä¾‹ï¼Œè¯¥æ–¹æ³•åœ¨ç¼–ç åˆ—è¡¨æ•°æ®å‰è¢«è°ƒç”¨ï¼Œç”¨æ¥ä¸ºç¼–ç åˆ—è¡¨æ•°æ®
// ä½œå‡†å¤‡ï¼Œå®é™…ä¸Šï¼Œè¯¥æ–¹æ³•çš„é€»è¾‘é€šè¿‡è°ƒç”¨å¦‚ä¸‹å‡½æ•°æ¥å®ç°ï¼š
//
//	EncodeBuffer.buf.listStart()
func (encBuf EncodeBuffer) ListStart() int {
	return encBuf.buf.listStart()
}

// ListEnd â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// ListEnd æ–¹æ³•æ¥å—ä¸€ä¸ªæ•´å‹å‚æ•°indexï¼Œè¯¥æ–¹æ³•åœ¨ç¼–ç åˆ—è¡¨æ•°æ®ç»“æŸä¹‹åè¢«è°ƒç”¨ï¼Œå…¶ç›®çš„å°±æ˜¯æ›´æ–° EncodeBuffer.buf.lHeads ä¸Šç»™å®š
// indexç´¢å¼•ä½å€¼å¤„çš„ listHead.size å’Œ EncodeBuffer.buf.lHeadsSize ä¸¤ä¸ªå­—æ®µã€‚å®é™…ä¸Šï¼Œè¯¥æ–¹æ³•çš„é€»è¾‘é€šè¿‡è°ƒç”¨å¦‚ä¸‹å‡½æ•°æ¥å®ç°ï¼š
//
//	EncodeBuffer.buf.listEnd(index)
func (encBuf EncodeBuffer) ListEnd(index int) {
	encBuf.buf.listEnd(index)
}

// encBufferFromWriter â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/11/5|
//
// encBufferFromWriter æ–¹æ³•æ¥å—ä¸€ä¸ªå®ç°äº† io.Writer æ¥å£çš„writerï¼Œå¦‚æœè¯¥writerçš„åº•å±‚å®ç°æ˜¯EncodeBufferæˆ–è€…
// æ˜¯*EncodeBufferï¼Œåˆ™è¿”å› EncodeBuffer.bufï¼Œå¦‚æœè¯¥writerçš„åº•å±‚å®ç°æ˜¯ *encBufferï¼Œåˆ™è¿”å›å®ƒè‡ªèº«ã€‚
func encBufferFromWriter(w io.Writer) *encBuffer {
	switch w := w.(type) {
	case EncodeBuffer:
		return w.buf
	case *EncodeBuffer:
		return w.buf
	case *encBuffer:
		return w
	default:
		return nil
	}
}
