package rlp

import (
	"github.com/232425wxy/understanding-ethereum/rlp/internal/rlpstruct"
	"io"
	"reflect"
)

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// å®šä¹‰ Encoder æ¥å£

// Encoder â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// é‚£äº›å®ç° Encoder æ¥å£çš„ç±»å‹ï¼Œå¯ä»¥è‡ªå®šä¹‰ç¼–ç è§„åˆ™ã€‚
type Encoder interface {
	EncodeRLP(io.Writer) error
}

var encoderInterface = reflect.TypeOf(new(Encoder)).Elem()

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// listHead â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/30|
//
// listHead å­˜å‚¨äº†ä¸€ä¸ªåˆ—è¡¨å¤´çš„ä¿¡æ¯ï¼Œå®˜æ–¹æºç çš„å†™æ³•æ˜¯"listhead"ï¼Œå¯æ˜¯è¿™åœ¨golandç¼–è¾‘å™¨é‡Œï¼Œä¼šæ˜¾ç¤ºæ³¢æµªçº¿ï¼Œçœ‹ç€å¾ˆé­å¿ƒï¼Œ
// æ‰€ä»¥æˆ‘æ”¹æˆäº†"listHead"ã€‚
type listHead struct {
	offset int
	size   int
}

// putHead â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// è¯¥æ–¹æ³•æ¥å—4ä¸ªå‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
//   - []byte bufï¼Œå¤´éƒ¨æ•°æ®ä¼šè¢«ç¼–ç åˆ°bufé‡Œé¢
//   - byte smallTagï¼ŒsmallTagçš„å–å€¼æœ‰ä¸¤ç§ï¼š0x80å’Œ0xC0ï¼Œåˆ†åˆ«å¯¹åº”largeTagçš„ä¸¤ç§å–å€¼
//   - byte largeTagï¼ŒlargeTagçš„å–å€¼æœ‰ä¸¤ç§ï¼š0xB7å’Œ0xF7ï¼Œåˆ†åˆ«å¯¹åº”smallTagçš„ä¸¤ç§å–å€¼
//   - uint64 sizeï¼Œsizeçš„å–å€¼æƒ…å†µåˆ†ä¸¤ç§ï¼Œå¤§äºæˆ–ç­‰äº56å’Œå°äº56
//
// putHead æ–¹æ³•çš„ä½œç”¨æ˜¯åœ¨ä¸ºæŸä¸ªæ•°æ®è¿›è¡Œç¼–ç æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¼–ç ç»“æœçš„å‰é¢åŠ ä¸€ä¸ªå¤´ï¼Œæ¥è¡¨ç¤ºå¤´åé¢è·Ÿç€å¤šé•¿çš„æ•°æ®æ˜¯å¯¹å‰é¢æ•°
// æ®è¿›è¡Œç¼–ç åçš„ç»“æœã€‚ä¸‹é¢ç»™å‡ºå‡ ä¸ªä¾‹å­ï¼š
//   - ç¼–ç çš„æ•°æ®æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º32çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä¼ å…¥çš„smallTagå’ŒlargeTagåˆ†åˆ«åº”è¯¥ç­‰äº0x80å’Œ0xB7ï¼Œsizeç­‰äº32ï¼Œé‚£ä¹ˆç¼–ç åçš„ç»“æœä¸ºï¼š
//     buf[0] = 0x80 + 32ï¼Œbuf[0] = 160 = 10100000
//   - ç¼–ç çš„æ•°æ®æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º64çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä¼ å…¥çš„smallTagå’ŒlargeTagåˆ†åˆ«åº”è¯¥ç­‰äº0x80å’Œ0xB7ï¼Œsizeç­‰äº32ï¼Œé‚£ä¹ˆç¼–ç åçš„ç»“æœä¸ºï¼š
//     buf[0] = 0xB7 + putInt(buf[1:], size) = 0xB8 = 184ï¼Œbuf[1] = 01000000
//   - ç¼–ç ä¸€ä¸ªåˆ—è¡¨ï¼Œç¼–ç åçš„æ•°æ®é•¿åº¦ç­‰äº36ï¼Œé‚£ä¹ˆä¼ å…¥çš„smallTagå’ŒlargeTagåˆ†åˆ«åº”è¯¥ç­‰äº0xCOå’Œ0xF7ï¼Œsizeç­‰äº36ï¼Œé‚£ä¹ˆç¼–ç åçš„ç»“æœä¸ºï¼š
//     buf[0] = 0xC0 + 36ï¼Œbuf[0] = 228 = 11100100
//   - ç¼–ç ä¸€ä¸ªåˆ—è¡¨ï¼Œç¼–ç åçš„æ•°æ®é•¿åº¦ç­‰äº456ï¼Œé‚£ä¹ˆä¼ å…¥çš„smallTagå’ŒlargeTagåˆ†åˆ«åº”è¯¥ç­‰äº0xCOå’Œ0xF7ï¼Œsizeç­‰äº456ï¼Œé‚£ä¹ˆç¼–ç åçš„ç»“æœä¸ºï¼š
//     buf[0] = 0xF7 + putInt(buf[1:], size) = 0xF7 + 2 = 0xF9 = 249ï¼Œbuf[1] = 00000001,11001000
//
// putHead æ–¹æ³•è¿”å›çš„å‚æ•°è¡¨ç¤ºç¼–ç å¤´çš„å¤§å°ï¼Œå³æ‰€å çš„å­—èŠ‚æ•°ï¼Œå¯¹äºç¼–ç é•¿åº¦å°äº56çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…ç¼–ç åˆ—è¡¨å¾—åˆ°é•¿åº¦å°äº56çš„ç¼–ç ç»“æœï¼Œç¼–ç å¤´çš„
// å¤§å°å§‹ç»ˆç­‰ä¸1ï¼›å¯¹äºç¼–ç é•¿åº¦å¤§äºæˆ–ç­‰äº56çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…ç¼–ç åˆ—è¡¨å¾—åˆ°é•¿åº¦å¤§äºæˆ–ç­‰äº56çš„ç¼–ç ç»“æœï¼Œç¼–ç å¤´çš„å¤§å°ç­‰äº1åŠ ä¸Šå¯¹é•¿åº¦è¿›è¡Œå¤§ç«¯ç¼–ç 
// åçš„é•¿åº¦ï¼Œå³1 + intSize(length)
func putHead(buf []byte, smallTag, largeTag byte, size uint64) int {
	if size < 56 {
		buf[0] = smallTag + byte(size)
		return 1
	}
	sizeSize := putInt(buf[1:], size) // å°†sizeæŒ‰ç…§å¤§ç«¯ç¼–ç çš„æ–¹å¼ç¼–ç åˆ°bufä¸­ï¼Œç„¶åè¿”å›æ‰€éœ€å ç”¨çš„å­—èŠ‚æ•°
	buf[0] = largeTag + byte(sizeSize)
	return sizeSize + 1
}

/*â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“â›“*/

// makeWriter â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// makeWriter æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯reflect.Type ç±»å‹çš„typï¼Œå¦ä¸€ä¸ªæ˜¯ rlpstruct.Tag ç±»å‹çš„ tagï¼Œç„¶åä¸ºtypç”Ÿæˆä¸“å±çš„
// ç¼–ç å™¨ï¼Œå…¶ä¸­tagå‚æ•°åªåœ¨ä¸ºå…ƒç´ ä¸ºébyteç±»å‹çš„åˆ‡ç‰‡ã€æ•°ç»„å’ŒæŒ‡é’ˆç±»å‹ç”Ÿæˆç¼–ç å™¨æ—¶æœ‰ç”¨ã€‚
func makeWriter(typ reflect.Type, tag rlpstruct.Tag) (writer, error) {
	return nil, nil
}

// putInt â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡bï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª64ä½æ— ç¬¦å·æ•´æ•°iï¼Œè¯¥æ–¹æ³•çš„ç›®çš„æ˜¯å°†iå­˜å‚¨åˆ°bé‡Œé¢ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå­˜å‚¨
// ä¸€ä¸ª64ä½æ— ç¬¦å·æ•´å‹æ•°å­—éœ€è¦64ä¸ªæ¯”ç‰¹ï¼Œå³8ä¸ªå­—èŠ‚ç©ºé—´ï¼Œä½†æ˜¯åœ¨å®é™…æƒ…å†µé‡Œï¼Œæˆ‘ä»¬ç”¨åˆ°çš„å¤§å¤šæ•°æ— ç¬¦å·æ•´æ•°éƒ½å¾ˆå°ï¼Œä¾‹å¦‚1234ï¼Œå¦‚æœå­˜å‚¨1234
// è¿™æ ·çš„æ•°å­—è¿˜ç”¨ä¸‹é¢è¿™æ ·çš„8ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼š
//
//	00000000,00000000,00000000,00000000,00000000,00000000,00000100,11010010
//
// å¯ä»¥å‘ç°å‰6ä¸ªå­—èŠ‚éƒ½æ˜¯0ï¼Œæœªå…è¿‡äºæµªè´¹å­˜å‚¨ç©ºé—´ï¼Œä¸ºæ­¤æˆ‘ä»¬è®¾æ³•åªå­˜å‚¨åé¢ä¸¤ä¸ªå¯ä»¥å®Œå…¨è¡¨ç¤ºæ•°å­—å¤§å°çš„å­—èŠ‚ï¼š00000100å’Œ11010010ï¼Œæˆ‘ä»¬
// æŠŠè¿™ä¸¤ä¸ªå­—èŠ‚çš„å†…å®¹æŒ‰ç…§å¤§ç«¯ç¼–ç çš„æ–¹å¼å­˜å‚¨åˆ°bé‡Œé¢ï¼Œå³00000100å­˜å‚¨åˆ°b[0]é‡Œé¢ï¼Œ11010010å­˜å‚¨åˆ°b[1]é‡Œé¢ï¼Œç„¶å putInt æ–¹æ³•è¿”å›çš„
// ç»“æœè¡¨ç¤ºæˆ‘ä»¬åœ¨bä¸­å­˜å‚¨iæ‰€éœ€çš„å­—èŠ‚æ ‘ç›®ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œæˆ‘ä»¬åªéœ€è¦2ä¸ªå­—èŠ‚å°±å¯ä»¥äº†ï¼Œå› æ­¤è¿”å›2ã€‚å®˜æ–¹æºç å°†æ­¤æ–¹æ³•å†™ä¸º"putint"ï¼Œæˆ‘å°†
// å…¶æ”¹æˆäº†"putInt"ã€‚
func putInt(b []byte, i uint64) (size int) {
	switch {
	case i < (1 << 8):
		b[0] = byte(i)
		return 1
	case i < (1 << 16):
		b[0] = byte(i >> 8) // å¤§ç«¯ç¼–ç ï¼Œé«˜ä½å­—èŠ‚æ”¾åœ¨ä½åœ°å€ä½
		b[1] = byte(i)
		return 2
	case i < (1 << 24):
		b[0] = byte(i >> 16)
		b[1] = byte(i >> 8)
		b[2] = byte(i)
		return 3
	case i < (1 << 32):
		b[0] = byte(i >> 24)
		b[1] = byte(i >> 16)
		b[2] = byte(i >> 8)
		b[3] = byte(i)
		return 4
	case i < (1 << 40):
		b[0] = byte(i >> 32)
		b[1] = byte(i >> 24)
		b[2] = byte(i >> 16)
		b[3] = byte(i >> 8)
		b[4] = byte(i)
		return 5
	case i < (1 << 48):
		b[0] = byte(i >> 40)
		b[1] = byte(i >> 32)
		b[2] = byte(i >> 24)
		b[3] = byte(i >> 16)
		b[4] = byte(i >> 8)
		b[5] = byte(i)
		return 6
	case i < (1 << 56):
		b[0] = byte(i >> 48)
		b[1] = byte(i >> 40)
		b[2] = byte(i >> 32)
		b[3] = byte(i >> 24)
		b[4] = byte(i >> 16)
		b[5] = byte(i >> 8)
		b[6] = byte(i)
		return 7
	default:
		b[0] = byte(i >> 56)
		b[1] = byte(i >> 48)
		b[2] = byte(i >> 40)
		b[3] = byte(i >> 32)
		b[4] = byte(i >> 24)
		b[5] = byte(i >> 16)
		b[6] = byte(i >> 8)
		b[7] = byte(i)
		return 8
	}
}

// intSize â™ |ä½œè€…ï¼šå´ç¿”å®‡| ğŸ |æ—¥æœŸï¼š2022/10/31|
//
// intSize æ–¹æ³•æ¥å—ä¸€ä¸ª64ä½çš„æ— ç¬¦å·æ•´æ•°ä½œä¸ºå…¥å‚ï¼Œè¯¥æ–¹æ³•è®¡ç®—æ•´æ•°iéœ€è¦å¤šå°‘ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼å«ä¹‰å’Œ putInt æ–¹æ³•ä¸€æ ·ã€‚
// å®˜æ–¹æºç çš„å†™æ³•æ˜¯"intsize"ï¼Œæˆ‘å°†å…¶æ”¹æˆäº†"intSize"ã€‚
func intSize(i uint64) int {
	for size := 1; ; size++ {
		if i >>= 8; i == 0 {
			return size
		}
	}
}
